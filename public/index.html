<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>NIMBY Rail Clone - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é‰„é“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
      body {
        margin: 0;
        overflow: hidden;
      }
      #map {
        height: 100vh;
        width: 100%;
        background-color: white;
      }

      .rail-ui-control,
      #game-stats,
      #login-overlay,
      #ranking-panel {
        background-color: rgba(255, 255, 255, 0.95);
        padding: 10px;
        border: 2px solid #333;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        font-family: Arial, sans-serif;
        z-index: 1000;
        position: absolute;
      }

      /* ãƒ­ã‚°ã‚¤ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
      #login-overlay {
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
      }
      #login-panel {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        text-align: center;
      }

      /* UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£: ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
      .rail-ui-control {
        top: 10px;
        left: 10px;
        width: 300px;
        max-height: 95vh; /* ç”»é¢ã®é«˜ã•ã«åˆã‚ã›ã¦æœ€å¤§é«˜ã•ã‚’è¨­å®š */
        overflow-y: auto; /* ç¸¦æ–¹å‘ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
      }

      /* UIã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä½ç½® */
      #game-stats {
        top: 10px;
        right: 10px;
        width: 300px;
        line-height: 1.5;
      }
      #ranking-panel {
        bottom: 10px;
        right: 10px;
        width: 300px;
      }

      /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ */
      .accordion-header {
        cursor: pointer;
        background-color: #f0f0f0;
        padding: 5px;
        border-bottom: 1px solid #ccc;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .accordion-content {
        padding-top: 10px;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }
      .accordion-content.open {
        max-height: 1000px;
      }

      /* ãƒœã‚¿ãƒ³ãƒ»ã‚»ãƒ¬ã‚¯ãƒˆ */
      .rail-ui-control button,
      .rail-ui-control select {
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid #555;
        background-color: #f5f5f5;
        border-radius: 3px;
        margin: 2px 0;
        width: 100%;
        box-sizing: border-box;
      }
      .rail-ui-control button.active {
        background-color: #007bff !important;
        color: white;
        border-color: #0056b3;
      }
      .time-display {
        font-size: 1.2em;
        font-weight: bold;
        color: #0044bb;
        margin-bottom: 10px;
      }

      /* åˆ—è»Šã‚¢ã‚¤ã‚³ãƒ³ã®èª¿æ•´ */
      .train-icon {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        transform: translate(-50%, -50%);
      }
      .station-icon {
        background-color: #000;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        cursor: pointer;
      }
      .leaflet-container.station-mode {
        cursor: crosshair;
      }
      .leaflet-container.dismantle-station-mode .station-icon {
        border-color: #ff0000;
        cursor: crosshair;
      }
      .leaflet-container.dismantle-line-mode {
        cursor: crosshair;
      }

      #error-message,
      #info-message {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 3000;
        display: none;
      }
      #error-message {
        background-color: #ff4444;
        color: white;
      }
      #info-message {
        background-color: #44aaff;
        color: white;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="login-overlay">
      <div id="login-panel">
        <h2>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é‰„é“ã‚·ãƒ ã¸ã‚ˆã†ã“ã</h2>
        <p>
          ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å‚åŠ ã™ã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br /><small
            >ï¼ˆæ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä»»æ„ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ç™»éŒ²ã§ãã¾ã™ï¼‰</small
          >
        </p>
        <input
          type="text"
          id="username-input"
          placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å"
          style="padding: 10px; margin-bottom: 10px; width: 80%"
        />
        <input
          type="password"
          id="password-input"
          placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
          style="padding: 10px; margin-bottom: 10px; width: 80%"
        />
        <button onclick="handleLogin()" style="width: 80%">
          ãƒ­ã‚°ã‚¤ãƒ³ / å‚åŠ 
        </button>
      </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ çµ±è¨ˆ (å³ä¸Šã®UI) -->
    <div id="game-stats">
      <div class="accordion-header" onclick="toggleAccordion('stats-content')">
        <span>ğŸ“Š ã‚²ãƒ¼ãƒ çµ±è¨ˆãƒ»æ™‚é–“ <span id="stats-toggle-icon">â–¼</span></span>
      </div>
      <div id="stats-content" class="accordion-content open">
        <p class="time-display">
          æ—¥æ™‚: <span id="game-date-time">åŒæœŸä¸­...</span>
        </p>
        <p>å€é€Ÿ: <span id="time-scale-display">x60</span> (ã‚µãƒ¼ãƒãƒ¼åˆ¶å¾¡)</p>
        <hr />
        <h3>ğŸ’° çµŒå–¶çŠ¶æ³ (ã‚ãªãŸ)</h3>
        <p>è³‡é‡‘: <span id="money-display">Â¥0</span></p>
        <p>ç·è³‡ç”£: <span id="asset-display">Â¥0</span></p>
        <p>æœˆæ¬¡ç¶­æŒè²»: <span id="maint-cost-display">Â¥0</span></p>
        <p>
          è»Šä¸¡æ•°: <span id="vehicle-count">0</span> | é§…æ•°:
          <span id="station-count">0</span>
        </p>
      </div>
    </div>

    <!-- å»ºè¨­ãƒ»è»Šä¸¡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« (å·¦ä¸Šã®UI) -->
    <div class="rail-ui-control">
      <div
        class="accordion-header"
        onclick="toggleAccordion('control-content')"
      >
        <span>ğŸ› ï¸ å»ºè¨­ãƒ»è»Šä¸¡æ“ä½œ <span id="control-toggle-icon">â–¼</span></span>
      </div>
      <div id="control-content" class="accordion-content open">
        <div style="text-align: center; margin-bottom: 10px">
          <button
            id="btn-station-mode"
            onclick="toggleConstructionMode('station')"
          >
            ğŸ  é§…ãƒ¢ãƒ¼ãƒ‰ (Â¥50M)
          </button>
          <button id="btn-track-mode" onclick="toggleConstructionMode('track')">
            ğŸ›¤ï¸ è·¯ç·šãƒ¢ãƒ¼ãƒ‰
          </button>
          <button onclick="finalizeLine()" style="margin-top: 5px">
            âœ… è·¯ç·šã‚’ç¢ºå®š
          </button>

          <hr
            style="margin: 10px 0; border: none; border-top: 1px solid #ccc"
          />

          <!-- è§£ä½“ãƒ¢ãƒ¼ãƒ‰ã®ãƒœã‚¿ãƒ³ -->
          <button
            id="btn-dismantle-station-mode"
            onclick="toggleConstructionMode('dismantle-station')"
            style="background-color: #ffc0cb"
          >
            ğŸ’¥ é§…è§£ä½“ãƒ¢ãƒ¼ãƒ‰
          </button>
          <button
            id="btn-dismantle-line-mode"
            onclick="toggleConstructionMode('dismantle-line')"
            style="background-color: #ffc0cb"
          >
            ğŸ’£ è·¯ç·šè§£ä½“ãƒ¢ãƒ¼ãƒ‰
          </button>

          <hr
            style="margin: 10px 0; border: none; border-top: 1px solid #ccc"
          />

          <button onclick="toggleConstructionMode('idle')">
            âŒ å»ºè¨­ã‚­ãƒ£ãƒ³ã‚»ãƒ«/ã‚¢ã‚¤ãƒ‰ãƒ«
          </button>

          <hr
            style="margin: 10px 0; border: none; border-top: 1px solid #ccc"
          />

          <label style="display: block; margin-bottom: 5px; font-weight: bold"
            >ç·šè·¯ã‚¿ã‚¤ãƒ—:</label
          >
          <select id="track-type" onchange="Game.currentTrackType = this.value">
            <option value="single">å˜ç·š (x1.0)</option>
            <option value="double">è¤‡ç·š (x1.8)</option>
            <option value="linear">ãƒªãƒ‹ã‚¢å°‚ç”¨ (x5.0)</option>
            <option value="tram">è·¯é¢é›»è»Šå°‚ç”¨ (x0.8)</option>
          </select>
        </div>
        <div id="vehicle-buy-container"></div>
      </div>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‘ãƒãƒ« (å³ä¸‹ã®UI) -->
    <div id="ranking-panel">
      <div
        class="accordion-header"
        onclick="toggleAccordion('ranking-content')"
      >
        <span
          >ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚° (å¯¾æˆ¦è¦ç´ )
          <span id="ranking-toggle-icon">â–¼</span></span
        >
      </div>
      <div id="ranking-content" class="accordion-content open">
        <ol id="ranking-list">
          <li>ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸä¸­...</li>
        </ol>
      </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé ˜åŸŸ -->
    <div id="error-message" style="display: none"></div>
    <div id="info-message" style="display: none"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
Â  Â  <script src="/socket.io/socket.io.js"></script>

Â  Â  <script>
Â  Â  Â  // =========================================================
Â  Â  Â  // A. ã‚²ãƒ¼ãƒ å®šæ•°ã¨çŠ¶æ…‹ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´)
Â  Â  Â  // =========================================================
Â  Â  Â  const INITIAL_LAT = 35.681236;
Â  Â  Â  const INITIAL_LNG = 139.767125;
Â  Â  Â  const STATION_COST = 50000000;
Â  Â  Â  const VEHICLE_BASE_COST = 8000000;

Â  Â  Â  let VehicleData = {};
Â  Â  Â  let map; // Leafletãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

Â  Â  Â  const Game = {
Â  Â  Â  Â  userId: null,
Â  Â  Â  Â  money: 0,
Â  Â  Â  Â  totalConstructionCost: 0,
Â  Â  Â  Â  establishedLines: [],
Â  Â  Â  Â  allLines: {},
Â  Â  Â  Â  stations: [],
Â  Â  Â  Â  vehicles: [],
Â  Â  Â  Â  // ğŸ’¡ ä¿®æ­£ 1: åˆ—è»ŠIDã‚’ã‚­ãƒ¼ã¨ã—ã€ãã®ãƒãƒ¼ã‚«ãƒ¼ã®é…åˆ—ã‚’å€¤ã¨ã™ã‚‹
Â  Â  Â  Â  allTrainMarkers: {}, // { trainId: [marker1, marker2, ...] }
Â  Â  Â  Â  mode: "idle",
Â  Â  Â  Â  currentTrackType: "single",
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ğŸ’¡ ä¿®æ­£ç‚¹ 4: UIæ›´æ–°ã®ãƒˆãƒªã‚¬ãƒ¼ç”¨å¤‰æ•°ã‚’è¿½åŠ 
Â  Â  Â  Â  _lastLineCount: 0,
Â  Â  Â  Â  _lastVehicleCount: 0,

Â  Â  Â  Â  updateStats(data) {
Â  Â  Â  Â  Â  // è³‡é‡‘ã€å»ºè¨­ã‚³ã‚¹ãƒˆã€è»Šä¸¡ã€è·¯ç·šæƒ…å ±ã‚’æ›´æ–°
Â  Â  Â  Â  Â  this.money = data.money !== undefined ? data.money : this.money;
Â  Â  Â  Â  Â  this.totalConstructionCost =
Â  Â  Â  Â  Â  Â  data.totalConstructionCost !== undefined
Â  Â  Â  Â  Â  Â  Â  ? data.totalConstructionCost
Â  Â  Â  Â  Â  Â  Â  : this.totalConstructionCost;
Â  Â  Â  Â  Â  this.establishedLines =
Â  Â  Â  Â  Â  Â  data.establishedLines !== undefined
Â  Â  Â  Â  Â  Â  Â  ? data.establishedLines
Â  Â  Â  Â  Â  Â  Â  : this.establishedLines;
Â  Â  Â  Â  Â  this.vehicles =
Â  Â  Â  Â  Â  Â  data.vehicles !== undefined ? data.vehicles : this.vehicles;

Â  Â  Â  Â  Â  if (data.stations) this.drawStations(data.stations);
Â  Â  Â  Â  Â  if (data.allLines) this.drawLines(data.allLines);

Â  Â  Â  Â  Â  this.updateFinancialUI();
Â  Â  Â  Â  },
Â  Â  Â  Â Â 
Â  Â  Â  Â  updateFinancialUI() {
Â  Â  Â  Â  	// ç·è³‡ç”£ã®å†è¨ˆç®—: è³‡é‡‘ + å»ºè¨­ã‚³ã‚¹ãƒˆã®70% (æ¸›ä¾¡å„Ÿå´ã‚’è€ƒæ…®) + è»Šä¸¡ã®è³¼å…¥ä¾¡æ ¼
Â  Â  Â  Â  	const totalAsset =
Â  Â  Â  Â  		this.money +
Â  Â  Â  Â  		this.totalConstructionCost * 0.7 +
Â  Â  Â  Â  		this.vehicles.length * VEHICLE_BASE_COST;
Â  Â  Â  Â  		
Â  Â  Â  Â  	document.getElementById("money-display").textContent = `Â¥${Math.round(
Â  Â  Â  Â  		this.money
Â  Â  Â  Â  	).toLocaleString()}`;
Â  Â  Â  Â  	document.getElementById("asset-display").textContent = `Â¥${Math.round(
Â  Â  Â  Â  		totalAsset
Â  Â  Â  Â  	).toLocaleString()}`;
Â  Â  Â  Â  	document.getElementById("vehicle-count").textContent =
Â  Â  Â  Â  		this.vehicles.length;
Â  Â  Â  Â  },

Â  Â  Â  Â  updateGlobalStats(data) {
Â  Â  Â  Â  	const gameTime = new Date(data.time);
Â  Â  Â  Â  	document.getElementById("game-date-time").textContent =
Â  Â  Â  Â  		this.formatDateTime(gameTime);
Â  Â  Â  Â  	document.getElementById(
Â  Â  Â  Â  		"time-scale-display"
Â  Â  Â  Â  	).textContent = `x${data.globalStats.timeScale}`;
Â  Â  Â  Â  	document.getElementById("maint-cost-display").textContent = `Â¥${(
Â  Â  Â  Â  		data.globalStats.lastMonthlyMaintenance || 0
Â  Â  Â  Â  	).toLocaleString()}`;
Â  Â  Â  Â  	document.getElementById("station-count").textContent =
Â  Â  Â  Â  		data.globalStats.stationsCount;
Â  Â  Â  Â  		
Â  Â  Â  Â  	// è³‡é‡‘ãŒå¤‰å‹•ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€è²¡å‹™UIã‚’æ›´æ–°
Â  Â  Â  Â  	this.updateFinancialUI();
Â  Â  Â  Â  },

Â  Â  Â  Â  formatDateTime(date) {
Â  Â  Â  Â  	const year = date.getFullYear();
Â  Â  Â  Â  	const month = date.getMonth() + 1;
Â  Â  Â  Â  	const day = date.getDate();
Â  Â  Â  Â  	const hour = date.getHours().toString().padStart(2, "0");
Â  Â  Â  Â  	return `${year}å¹´${month}æœˆ${day}æ—¥ ${hour}æ™‚`;
Â  Â  Â  Â  },

Â  Â  Â  Â  drawStations(stations) {
Â  Â  Â  Â  	this.stations.forEach((s) => map.removeLayer(s.marker));
Â  Â  Â  Â  	this.stations = [];
Â  Â  Â  Â  	stations.forEach(
Â  Â  Â  Â  		(s) =>
Â  Â  Â  Â  			new Station(
Â  Â  Â  Â  				s.id,
Â  Â  Â  Â  				{ lat: s.latlng[0], lng: s.latlng[1] },
Â  Â  Â  Â  				map,
Â  Â  Â  Â  				s.ownerId
Â  Â  Â  Â  			)
Â  Â  Â  Â  	);
Â  Â  Â  Â  },

Â  Â  Â  Â  drawLines(lines) {
Â  Â  Â  Â  	Object.values(this.allLines).forEach((l) => map.removeLayer(l));
Â  Â  Â  Â  	this.allLines = {};
Â  Â  Â  Â  	// lines ã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è·¯ç·šãƒ‡ãƒ¼ã‚¿
Â  Â  Â  Â  	lines.forEach((line) => this.drawLine(line));
Â  Â  Â  Â  },

Â  Â  Â  Â  drawLine(line) {
Â  Â  Â  Â  	let weight = 8;
Â  Â  Â  Â  	if (line.trackType === "double") weight = 12;
Â  Â  Â  Â  	else if (line.trackType === "linear") weight = 15;
Â  Â  Â  Â  	else if (line.trackType === "tram") weight = 6;

Â  Â  Â  Â  	// è‡ªåˆ†ã®è·¯ç·šã¯å¤ªãã€ä»–äººã®è·¯ç·šã¯ç´°ãã™ã‚‹ãªã©ã®èª¿æ•´ã‚‚å¯èƒ½
Â  Â  Â  Â  	const isMyLine = line.ownerId === Game.userId;
Â  Â  Â  Â  	const finalStyle = {
Â  Â  Â  Â  		color: line.color,
Â  Â  Â  Â  		weight: isMyLine ? weight : weight * 0.7, // ä»–äººã®è·¯ç·šã¯å°‘ã—ç´°ã
Â  Â  Â  Â  		opacity: isMyLine ? 1 : 0.7, // ä»–äººã®è·¯ç·šã¯å°‘ã—è–„ã
Â  Â  Â  Â  		lineCap: "round",
Â  Â  Â  Â  	};
Â  Â  Â  Â  	this.allLines[line.id] = L.polyline(line.coords, finalStyle)
Â  Â  Â  Â  		.addTo(map);
Â  Â  Â  Â  },
Â  Â  Â  };

Â  Â  Â  let socket;
Â  Â  Â  let drawingPolyline = null;
Â  Â  Â  let lineCandidateNodes = [];

Â  Â  Â  class Station {
Â  Â  Â  Â  constructor(id, latlng, map, ownerId) {
Â  Â  Â  Â  	this.id = id;
Â  Â  Â  Â  	this.latlng = latlng;
Â  Â  Â  Â  	this.ownerId = ownerId;
Â  Â  Â  Â  	this.name = `é§… ${id}`;

Â  Â  Â  Â  	// è‡ªåˆ†ã®é§…ã¯é’ã€ä»–äººã®é§…ã¯èµ¤
Â  Â  Â  Â  	const stationColor = ownerId === Game.userId ? "#0044BB" : "#FF0000";

Â  Â  Â  Â  	this.marker = L.marker(latlng, {
Â  Â  Â  Â  		icon: L.divIcon({
Â  Â  Â  Â  			className: "station-icon",
Â  Â  Â  Â  			style: `background-color: ${stationColor};`,
Â  Â  Â  Â  		}),
Â  Â  Â  Â  		title: this.name,
Â  Â  Â  Â  	}).addTo(map);

Â  Â  Â  Â  	this.marker.bindPopup(
Â  Â  Â  Â  		`<b>${this.name} (ID: ${this.id})</b><br>Owner: ${ownerId}`
Â  Â  Â  Â  	);
Â  Â  Â  Â  	this.marker.on("click", (e) => {
Â  Â  Â  Â  		if (Game.mode === "track" || Game.mode === "dismantle-station") {
Â  Â  Â  Â  			handleStationClick(this);
Â  Â  Â  Â  			L.DomEvent.stopPropagation(e); // Leafletã®ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’åœæ­¢
Â  Â  Â  Â  			
Â  Â  Â  Â  			// å…ƒã®DOMã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚‚åœæ­¢ã—ã€UIã®å®‰å®šæ€§ã‚’å‘ä¸Š
Â  Â  Â  Â  			if (e.originalEvent) {
Â  Â  Â  Â  				e.originalEvent.stopPropagation();
Â  Â  Â  Â  			}
Â  Â  Â  Â  		}
Â  Â  Â  Â  	});
Â  Â  Â  Â  	Game.stations.push(this);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // =========================================================
Â  Â  Â  // B. ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ”ãƒ¼å¯¾å¿œãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ğŸ’¡ ä¿®æ­£ 2: æ—¥æ™‚å¤‰æ›´ç·šè¶Šãˆã®ãƒãƒ¼ã‚«ãƒ¼è¤‡è£½ã‚’å‡¦ç†
Â  Â  Â  // =========================================================

Â  Â  Â  /**
Â  Â  Â  Â * çµŒåº¦Â±180åº¦ã‚’è¶ŠãˆãŸå ´åˆã«ã€ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ”ãƒ¼ä¸Šã®å¯¾å¿œã™ã‚‹ç·¯åº¦çµŒåº¦ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
Â  Â  Â  Â * åˆ—è»ŠãŒæ—¥ä»˜å¤‰æ›´ç·šä»˜è¿‘ã«ã„ã‚‹å ´åˆã€2ã¤ã®åº§æ¨™ã‚’è¿”ã—ã¾ã™ã€‚
Â  Â  Â  Â * @param {object} latlng - {lat: number, lng: number} å½¢å¼ã®åº§æ¨™ã€‚
Â  Â  Â  Â * @returns {Array<object>} - å…ƒã®åº§æ¨™ã¨ã€å¿…è¦ã«å¿œã˜ã¦Â±360åº¦ã•ã‚ŒãŸåº§æ¨™ã®é…åˆ—ã€‚
Â  Â  Â  Â */
Â  Â  Â  function getClonedCoordinates(latlng) {
Â  Â  Â  Â  Â  const coords = [{ lat: latlng.lat, lng: latlng.lng }];

Â  Â  Â  Â  Â  // å¢ƒç•Œã‹ã‚‰10åº¦ä»¥å†…ï¼ˆ170åº¦ã‹ã‚‰-180åº¦ã€ã¾ãŸã¯-170åº¦ã‹ã‚‰180åº¦ï¼‰ã®å ´åˆã«ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆã€‚
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // çµŒåº¦ -180åº¦ä»˜è¿‘ã«ã„ã‚‹å ´åˆã€+360åº¦ã—ãŸåº§æ¨™ã‚’è¿½åŠ 
Â  Â  Â  Â  Â  // ä¾‹: -179åº¦ -> 181åº¦ (å³å´ã®ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ”ãƒ¼)
Â  Â  Â  Â  Â  if (latlng.lng < -170) {
Â  Â  Â  Â  Â  Â  Â  coords.push({ lat: latlng.lat, lng: latlng.lng + 360 });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  // çµŒåº¦ +180åº¦ä»˜è¿‘ã«ã„ã‚‹å ´åˆã€-360åº¦ã—ãŸåº§æ¨™ã‚’è¿½åŠ 
Â  Â  Â  Â  Â  // ä¾‹: 179åº¦ -> -181åº¦ (å·¦å´ã®ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ”ãƒ¼)
Â  Â  Â  Â  Â  else if (latlng.lng > 170) {
Â  Â  Â  Â  Â  Â  Â  coords.push({ lat: latlng.lat, lng: latlng.lng - 360 });
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  return coords;
Â  Â  Â  }

Â  Â  Â  // =========================================================
Â  Â  Â  // C. ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã¨èªè¨¼
Â  Â  Â  // =========================================================

Â  Â  Â  function getCookie(name) {
Â  Â  Â  Â  	const nameEQ = name + "=";
Â  Â  Â  Â  	const ca = document.cookie.split(";");
Â  Â  Â  Â  	for (let i = 0; i < ca.length; i++) {
Â  Â  Â  Â  		let c = ca[i];
Â  Â  Â  Â  		while (c.charAt(0) === " ") c = c.substring(1, c.length);
Â  Â  Â  Â  		if (c.indexOf(nameEQ) === 0)
Â  Â  Â  Â  			return c.substring(nameEQ.length, c.length);
Â  Â  Â  Â  	}
Â  Â  Â  Â  	return null;
Â  Â  Â  }

Â  Â  Â  async function handleLogin() {
Â  Â  Â  Â  	const username = document.getElementById("username-input").value.trim();
Â  Â  Â  Â  	const password = document.getElementById("password-input").value.trim();

Â  Â  Â  Â  	if (username.length < 3 || password.length === 0) {
Â  Â  Â  Â  		alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
Â  Â  Â  Â  		return;
Â  Â  Â  Â  	}

Â  Â  Â  Â  	try {
Â  Â  Â  Â  		const response = await fetch("/login", {
Â  Â  Â  Â  			method: "POST",
Â  Â  Â  Â  			headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  			body: JSON.stringify({ username: username, password: password }),
Â  Â  Â  Â  		});
Â  Â  Â  Â  		const data = await response.json();

Â  Â  Â  Â  		if (data.success) {
Â  Â  Â  Â  			Game.userId = data.userId;
Â  Â  Â  Â  			document.getElementById("login-overlay").style.display = "none";
Â  Â  Â  Â  			connectSocket(Game.userId);
Â  Â  Â  Â  		} else {
Â  Â  Â  Â  			alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + data.message);
Â  Â  Â  Â  		}
Â  Â  Â  Â  	} catch (error) {
Â  Â  Â  Â  		console.error("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", error);
Â  Â  Â  Â  		alert("ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
Â  Â  Â  Â  	}
Â  Â  Â  }

Â  Â  Â  function connectSocket(userId) {
Â  Â  Â  Â  	socket = io();

Â  Â  Â  Â  	socket.on("connect", () => {
Â  Â  Â  Â  		socket.emit("login", { userId: userId });
Â  Â  Â  Â  	});

Â  Â  Â  Â  	socket.on("initialState", (data) => {
Â  Â  Â  Â  		VehicleData = data.vehicleData;
Â  Â  Â  Â  		Game.updateStats(data);
Â  Â  Â  Â  		
Â  Â  Â  Â  		if (data.allLines) {
Â  Â  Â  Â  			Game.drawLines(data.allLines);
Â  Â  Â  Â  		}
Â  Â  Â  Â  		
Â  Â  Â  Â  		// ğŸ’¡ ä¿®æ­£ç‚¹ 5: åˆå›ã¯å¿…ãšUIã‚’æ›´æ–°ã—ã€ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆæœŸåŒ–
Â  Â  Â  Â  		updateVehicleBuyUI();
Â  Â  Â  Â  		Game._lastLineCount = data.establishedLines ? data.establishedLines.length : 0;
Â  Â  Â  Â  		Game._lastVehicleCount = data.vehicles ? data.vehicles.length : 0;
Â  Â  Â  Â  	});

Â  Â  Â  Â  	socket.on("updateUserState", (data) => {
Â  Â  Â  Â  		// è³‡é‡‘ã€å»ºè¨­ã‚³ã‚¹ãƒˆã€è»Šä¸¡ãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹ (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åç›Šæ›´æ–°ã‚’å«ã‚€)
Â  Â  Â  Â  		Game.updateStats(data);
Â  Â  Â  Â  		
Â  Â  Â  Â  		// ğŸ’¡ ä¿®æ­£ç‚¹ 6: è·¯ç·šæ•°ã¾ãŸã¯è»Šä¸¡æ•°ã«å¤‰åŒ–ãŒã‚ã£ãŸå ´åˆã®ã¿UIã‚’æ›´æ–°
Â  Â  Â  Â  		const currentLineCount = data.establishedLines ? data.establishedLines.length : Game._lastLineCount;
Â  Â  Â  Â  		const currentVehicleCount = data.vehicles ? data.vehicles.length : Game._lastVehicleCount;

Â  Â  Â  Â  		if (currentLineCount !== Game._lastLineCount || currentVehicleCount !== Game._lastVehicleCount) {
Â  Â  Â  Â  			updateVehicleBuyUI();
Â  Â  Â  Â  			Game._lastLineCount = currentLineCount;
Â  Â  Â  Â  			Game._lastVehicleCount = currentVehicleCount;
Â  Â  Â  Â  		}
Â  Â  Â  Â  	});

Â  Â  Â  Â  	socket.on("gameUpdate", (data) => {
Â  Â  Â  Â  		// æ™‚é–“ã€æœˆæ¬¡ç¶­æŒè²»ã€é§…æ•°ãªã©ãŒæ›´æ–°ã•ã‚Œã‚‹ (å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘)
Â  Â  Â  Â  		Game.updateGlobalStats(data);
Â  Â  Â  Â  		updateTrainPositions(data.trainPositions);
Â  Â  Â  Â  	});

Â  Â  Â  Â  	socket.on("rankingUpdate", (ranking) => {
Â  Â  Â  Â  		updateRankingUI(ranking);
Â  Â  Â  Â  	});

Â  Â  Â  Â  	socket.on("stationBuilt", (data) => {
Â  Â  Â  Â  		new Station(data.id, data.latlng, map, data.ownerId);
Â  Â  Â  Â  		// é§…æ•°ãŒå¤‰ã‚ã£ãŸã®ã§ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆã‚’å†æç”»
Â  Â  Â  Â  		Game.updateGlobalStats({ globalStats: { stationsCount: Game.stations.length } });
Â  Â  Â  Â  	});

Â  Â  Â  Â  	socket.on("lineBuilt", (data) => {
Â  Â  Â  Â  		Game.drawLine(data);
Â  Â  Â  Â  		// è‡ªåˆ†ã®è·¯ç·šãƒªã‚¹ãƒˆã®æ›´æ–°ã¯updateUserStateã«ä»»ã›ã‚‹
Â  Â  Â  Â  	});

Â  Â  Â  Â  	socket.on("lineDismantled", (data) => {
Â  Â  Â  Â  		if (Game.allLines[data.lineId]) {
Â  Â  Â  Â  			map.removeLayer(Game.allLines[data.lineId]);
Â  Â  Â  Â  			delete Game.allLines[data.lineId];
Â  Â  Â  Â  		}
Â  Â  Â  Â  		// è‡ªåˆ†ã®è·¯ç·šãƒªã‚¹ãƒˆã®æ›´æ–°ã¯updateUserStateã«ä»»ã›ã‚‹
Â  Â  Â  Â  	});

Â  Â  Â  Â  	socket.on("stationDismantled", (data) => {
Â  Â  Â  Â  		const stationIndex = Game.stations.findIndex(
Â  Â  Â  Â  			(s) => s.id === data.stationId
Â  Â  Â  Â  		);
Â  Â  Â  Â  		if (stationIndex !== -1) {
Â  Â  Â  Â  			map.removeLayer(Game.stations[stationIndex].marker);
Â  Â  Â  Â  			Game.stations.splice(stationIndex, 1);
Â  Â  Â  Â  		}
Â  Â  Â  Â  		// é§…æ•°ãŒå¤‰ã‚ã£ãŸã®ã§ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆã‚’å†æç”»
Â  Â  Â  Â  		Game.updateGlobalStats({ globalStats: { stationsCount: Game.stations.length } });
Â  Â  Â  Â  	});

Â  Â  Â  Â  	socket.on("error", (message) => {
Â  Â  Â  Â  		const errorDiv = document.getElementById("error-message");
Â  Â  Â  Â  		errorDiv.textContent = message;
Â  Â  Â  Â  		errorDiv.style.display = "block";
Â  Â  Â  Â  		setTimeout(() => {
Â  Â  Â  Â  			errorDiv.style.display = "none";
Â  Â  Â  Â  		}, 5000);
Â  Â  Â  Â  	});

Â  Â  Â  Â  	socket.on("info", (message) => {
Â  Â  Â  Â  		const infoDiv = document.getElementById("info-message");
Â  Â  Â  Â  		infoDiv.textContent = message;
Â  Â  Â  Â  		infoDiv.style.display = "block";
Â  Â  Â  Â  		setTimeout(() => {
Â  Â  Â  Â  			infoDiv.style.display = "none";
Â  Â  Â  Â  		}, 5000);
Â  Â  Â  Â  	});
Â  Â  Â  }

Â  Â  Â  // ğŸ’¡ ä¿®æ­£ 3: updateTrainPositionsé–¢æ•°ã‚’ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ”ãƒ¼å¯¾å¿œã«æ›¸ãæ›ãˆ
Â  Â  Â  function updateTrainPositions(trainPositions) {
Â  Â  Â  Â  	// 1. ä»Šå›æ›´æ–°ã™ã‚‹åˆ—è»Šã®IDã‚»ãƒƒãƒˆã‚’ä½œæˆ
Â  Â  Â  Â  	const updatedTrainIds = new Set(trainPositions.map(t => t.id));

Â  Â  Â  Â  	trainPositions.forEach((train) => {
Â  Â  Â  Â  		// ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ”ãƒ¼ã®åº§æ¨™ã‚’å–å¾— (é€šå¸¸ã¯1ã¤ã€å¢ƒç•Œä»˜è¿‘ã§ã¯2ã¤)
Â  Â  Â  Â  		const clonedLatlngs = getClonedCoordinates(train.latlng);
Â  Â  Â  Â  		
Â  Â  Â  Â  		let markers = Game.allTrainMarkers[train.id] || [];

Â  Â  Â  Â  		// ä¸è¶³ã—ã¦ã„ã‚‹ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ ï¼ˆæœ€å¤§2ã¤ã‚’æƒ³å®šï¼‰
Â  Â  Â  Â  		while (markers.length < clonedLatlngs.length) {
Â  Â  Â  Â  			// ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®å®šç¾©
Â  Â  Â  Â  			const markerIcon = L.divIcon({
Â  Â  Â  Â  				className: "train-icon",
Â  Â  Â  Â  				style: `background-color: ${train.color}; border-color: ${
Â  Â  Â  Â  					train.owner === Game.userId ? "yellow" : "white"
Â  Â  Â  Â  				};`,
Â  Â  Â  Â  			});

Â  Â  Â  Â  			const newMarker = L.marker([0, 0], { // ä¸€æ—¦ãƒ€ãƒŸãƒ¼åº§æ¨™ã§ä½œæˆ
Â  Â  Â  Â  				icon: markerIcon,
Â  Â  Â  Â  			}).addTo(map);

Â  Â  Â  Â  			newMarker.bindPopup(
Â  Â  Â  Â  				`åˆ—è»Š #${train.id} (Owner: ${train.owner})`
Â  Â  Â  Â  			);
Â  Â  Â  Â  			markers.push(newMarker);
Â  Â  Â  Â  		}

Â  Â  Â  Â  		// ãƒãƒ¼ã‚«ãƒ¼ã‚’æ–°ã—ã„åº§æ¨™ã«ç§»å‹•ã—ã€ä¸è¦ãªãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
Â  Â  Â  Â  		markers.forEach((marker, index) => {
Â  Â  Â  Â  			if (clonedLatlngs[index]) {
Â  Â  Â  Â  				// å¿…è¦ãªãƒãƒ¼ã‚«ãƒ¼: åº§æ¨™ã‚’è¨­å®šã—ã€åœ°å›³ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
Â  Â  Â  Â  				marker.setLatLng(clonedLatlngs[index]).addTo(map);
Â  Â  Â  Â  			} else {
Â  Â  Â  Â  				// ä¸è¦ã«ãªã£ãŸãƒãƒ¼ã‚«ãƒ¼: åœ°å›³ã‹ã‚‰å‰Šé™¤
Â  Â  Â  Â  				map.removeLayer(marker); 
Â  Â  Â  Â  			}
Â  Â  Â  Â  		});

Â  Â  Â  Â  		// æœ€çµ‚çš„ãªãƒãƒ¼ã‚«ãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–° (åœ°å›³ä¸Šã«å­˜åœ¨ã™ã‚‹ãƒãƒ¼ã‚«ãƒ¼ã®ã¿æ®‹ã™)
Â  Â  Â  Â  		Game.allTrainMarkers[train.id] = markers.filter(m => map.hasLayer(m));
Â  Â  Â  Â  	});
Â  Â  Â  Â  	
Â  Â  Â  Â  	// 2. ä»Šå›ä½ç½®æƒ…å ±ãŒé€ã‚‰ã‚Œã¦ã“ãªã‹ã£ãŸåˆ—è»Šï¼ˆé‹è¡Œåœæ­¢ãƒ»è§£ä½“ãªã©ï¼‰ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’åœ°å›³ã‹ã‚‰å‰Šé™¤
Â  Â  Â  Â  	Object.keys(Game.allTrainMarkers).forEach((trainId) => {
Â  Â  Â  Â  		if (!updatedTrainIds.has(parseInt(trainId))) {
Â  Â  Â  Â  			Game.allTrainMarkers[trainId].forEach(marker => {
Â  Â  Â  Â  				map.removeLayer(marker);
Â  Â  Â  Â  			});
Â  Â  Â  Â  			delete Game.allTrainMarkers[trainId];
Â  Â  Â  Â  		}
Â  Â  Â  Â  	});
Â  Â  Â  }

Â  Â  Â  function updateRankingUI(ranking) {
Â  Â  Â  Â  	const list = document.getElementById("ranking-list");
Â  Â  Â  Â  	list.innerHTML = "";
Â  Â  Â  Â  	// 3. ä»–ã®äººã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§ä¸€äººã—ã‹è¦‹ãˆãªã„: ã‚µãƒ¼ãƒãƒ¼å´ã§å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ãŸãŸã‚ã€ã“ã“ã§ã¯è¡¨ç¤ºã™ã‚‹ã ã‘
Â  Â  Â  Â  	ranking.forEach((item, index) => {
Â  Â  Â  Â  		const li = document.createElement("li");
Â  Â  Â  Â  		li.innerHTML = `${index + 1}. <b>${item.userId}</b>: Â¥${Math.round(
Â  Â  Â  Â  			item.score
Â  Â  Â  Â  		).toLocaleString()}`;
Â  Â  Â  Â  		if (item.userId === Game.userId) {
Â  Â  Â  Â  			li.style.fontWeight = "bold";
Â  Â  Â  Â  			li.style.color = "#0044BB";
Â  Â  Â  Â  		}
Â  Â  Â  Â  		list.appendChild(li);
Â  Â  Â  Â  	});
Â  Â  Â  }

Â  Â  Â  // =========================================================
Â  Â  Â  // D. å»ºè¨­ãƒ»è§£ä½“ãƒ­ã‚¸ãƒƒã‚¯ (ã‚µãƒ¼ãƒãƒ¼ã«ã‚³ãƒãƒ³ãƒ‰é€ä¿¡)
Â  Â  Â  // =========================================================

Â  Â  Â  Â function handleStationCreation(e) {
Â  Â  Â  Â  	if (Game.mode !== "station" || !socket) return;
Â  Â  Â  Â  	// 2. ç¯„å›²å†…ã«ç›¸æ‰‹ã®é§…ãŒã‚ã‚‹ã¨ç«‹ã¦ã‚Œãªãã™ã‚‹: ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†
Â  Â  Â  Â  	socket.emit("buildStation", { latlng: e.latlng });
Â  Â  Â  Â  }

Â  Â  Â  function handleStationDismantle(station) {
Â  Â  Â  Â  	if (Game.mode !== "dismantle-station" || !socket) return;

Â  Â  Â  Â  	if (station.ownerId !== Game.userId) {
Â  Â  Â  Â  		alert("è‡ªåˆ†ã®é§…ã—ã‹è§£ä½“ã§ãã¾ã›ã‚“ã€‚");
Â  Â  Â  Â  		return;
Â  Â  Â  Â  	}

Â  Â  Â  Â  	const dismantleCost = Math.round(STATION_COST * 0.1);
Â  Â  Â  Â  	if (
Â  Â  Â  Â  		confirm(
Â  Â  Â  Â  			`é§… ${
Â  Â  Â  Â  				station.id
Â  Â  Â  Â  			} ã‚’è§£ä½“ã—ã¾ã™ã‹ï¼Ÿ (è²»ç”¨: Â¥${dismantleCost.toLocaleString()})`
Â  Â  Â  Â  		)
Â  Â  Â  Â  	) {
Â  Â  Â  Â  		socket.emit("dismantleStation", { stationId: station.id });
Â  Â  Â  Â  	}
Â  Â  Â  }

Â  Â  Â  function handleStationClick(station) {
Â  Â  Â  Â  	if (Game.mode === "track") {
Â  Â  Â  Â  		// è·¯ç·šå»ºè¨­ãƒ¢ãƒ¼ãƒ‰
Â  Â  Â  Â  		if (station.ownerId !== Game.userId) {
Â  Â  Â  Â  			alert("ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é§…ã¯è·¯ç·šã®ãƒãƒ¼ãƒ‰ã¨ã—ã¦ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚");
Â  Â  Â  Â  			return;
Â  Â  Â  Â  		}

Â  Â  Â  Â  		if (lineCandidateNodes.includes(station)) return;

Â  Â  Â  Â  		lineCandidateNodes.push(station);

Â  Â  Â  Â  		const currentCoords = lineCandidateNodes.map((s) => [
Â  Â  Â  Â  			s.latlng.lat,
Â  Â  Â  Â  			s.latlng.lng,
Â  Â  Â  Â  		]);

Â  Â  Â  Â  		if (currentCoords.length >= 2) {
Â  Â  Â  Â  			let weight = 7;
Â  Â  Â  Â  			if (Game.currentTrackType === "double") weight = 12;
Â  Â  Â  Â  			else if (Game.currentTrackType === "linear") weight = 15;
Â  Â  Â  Â  			else if (Game.currentTrackType === "tram") weight = 6;

Â  Â  Â  Â  			if (drawingPolyline) {
Â  Â  Â  Â  				drawingPolyline
Â  Â  Â  Â  					.setLatLngs(currentCoords)
Â  Â  Â  Â  					.setStyle({ color: "#C0C0C0", weight: weight });
Â  Â  Â  Â  			} else {
Â  Â  Â  Â  				drawingPolyline = L.polyline(currentCoords, {
Â  Â  Â  Â  					color: "#C0C0C0",
Â  Â  Â  Â  					weight: weight,
Â  Â  Â  Â  					opacity: 0.8,
Â  Â  Â  Â  					dashArray: "10, 10",
Â  Â  Â  Â  				}).addTo(map);
Â  Â  Â  			}
Â  Â  Â  Â  		}
Â  Â  Â  Â  	} else if (Game.mode === "dismantle-station") {
Â  Â  Â  Â  		// é§…è§£ä½“ãƒ¢ãƒ¼ãƒ‰
Â  Â  Â  Â  		handleStationDismantle(station);
Â  Â  Â  Â  	}
Â  Â  Â  }

Â  Â  Â  function finalizeLine() {
Â  Â  Â  Â  	if (lineCandidateNodes.length < 2 || !socket) {
Â  Â  Â  Â  		alert("è·¯ç·šã«ã¯2ã¤ä»¥ä¸Šã®é§…ãŒå¿…è¦ã§ã™ã€‚");
Â  Â  Â  Â  		return;
Â  Â  Â  Â  	}

Â  Â  Â  Â  	const stationCoords = lineCandidateNodes.map((s) => [
Â  Â  Â  Â  		s.latlng.lat,
Â  Â  Â  Â  		s.latlng.lng,
Â  Â  Â  Â  	]);

Â  Â  Â  Â  	socket.emit("buildLine", {
Â  Â  Â  Â  		stationCoords: stationCoords,
Â  Â  Â  Â  		trackType: Game.currentTrackType,
Â  Â  Â  Â  	});

Â  Â  Â  Â  	if (drawingPolyline) map.removeLayer(drawingPolyline);
Â  Â  Â  Â  	lineCandidateNodes = [];
Â  Â  Â  Â  	drawingPolyline = null;
Â  Â  Â  Â  	toggleConstructionMode("idle");
Â  Â  Â  }

Â  Â  Â  function handleLineDismantle(e) {
Â  Â  Â  Â  	if (Game.mode !== "dismantle-line" || !socket) return;

Â  Â  Â  Â  	let closestLine = null;
Â  Â  Â  Â  	let closestLineId = null;
Â  Â  Â  	let minDistance = Infinity;
Â  Â  Â  	const lineSearchRadiusMeters = 50; // 50mä»¥å†…ã‚’è¨±å®¹ç¯„å›²ã¨ã™ã‚‹

Â  Â  Â  Â  	// ğŸ”¹å…¨ã¦ã®è·¯ç·šã‚’å¯¾è±¡ã«ã™ã‚‹
Â  Â  Â  Â  	Object.entries(Game.allLines).forEach(([lineId, polyline]) => {
Â  Â  Â  Â  		const latlngs = polyline.getLatLngs();
Â  Â  Â  Â  		latlngs.forEach((latlng) => {
Â  Â  Â  Â  			const dist = e.latlng.distanceTo(latlng);
Â  Â  Â  Â  			if (dist < minDistance && dist < lineSearchRadiusMeters) {
Â  Â  Â  Â  				minDistance = dist;
Â  Â  Â  Â  				closestLine = polyline;
Â  Â  Â  Â  				closestLineId = lineId;
Â  Â  Â  Â  			}
Â  Â  Â  Â  		});
Â  Â  Â  Â  	});

Â  Â  Â  Â  	if (!closestLine || !closestLineId) {
Â  Â  Â  Â  		alert("ã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã®è¿‘ãã«è§£ä½“ã§ãã‚‹è·¯ç·šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
Â  Â  Â  Â  		return;
Â  Â  Â  Â  	}

Â  Â  Â  Â  	// ğŸ”¹lineIdã‹ã‚‰lineDataã‚’å–å¾—
Â  Â  Â  Â  	// Game.establishedLines ã«ã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚³ã‚¹ãƒˆæƒ…å ±ãŒå«ã¾ã‚Œã¦é€ã‚‰ã‚Œã¦ãã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
Â  Â  Â  Â  	const lineData = Game.establishedLines.find((l) => l.id == closestLineId);

Â  Â  Â  Â  	// ğŸ”¹ã‚ªãƒ¼ãƒŠãƒ¼ç¢ºèªï¼ˆè‡ªåˆ†ã®è·¯ç·šã—ã‹è§£ä½“ã§ããªã„ï¼‰
Â  Â  Â  Â  	if (!lineData || lineData.ownerId !== Game.userId) {
Â  Â  Â  Â  		alert("è‡ªåˆ†ã®è·¯ç·šã®ã¿è§£ä½“å¯èƒ½ã§ã™ã€‚");
Â  Â  Â  Â  		return;
Â  Â  Â  Â  	}

Â  Â  Â  Â  	// ä¿®æ­£: lineData.cost ã‚’ä½¿ç”¨
Â  Â  Â  Â  	const dismantleCost = Math.round(lineData.cost * 0.1);
Â  Â  Â  Â  	if (
Â  Â  Â  Â  		confirm(
Â  Â  Â  Â  			`è·¯ç·š ${closestLineId} ã‚’è§£ä½“ã—ã¾ã™ã‹ï¼Ÿ (è²»ç”¨: Â¥${dismantleCost.toLocaleString()}ã€è»Šä¸¡ã¯è³¼å…¥ä¾¡æ ¼ã®1/3ã§è‡ªå‹•å£²å´ã•ã‚Œã¾ã™)`
Â  Â  Â  Â  		)
Â  Â  Â  Â  	) {
Â  Â  Â  Â  		socket.emit("dismantleLine", { lineId: parseInt(closestLineId) });
Â  Â  Â  Â  	}
Â  Â  Â  }


Â  Â  Â  // =========================================================
Â  Â  Â  // E. UIã¨ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
Â  Â  Â  // =========================================================

Â  Â  Â  function toggleConstructionMode(newMode) {
Â  Â  Â  Â  	const mapContainer = map.getContainer();

Â  Â  Â  Â  	L.DomUtil.removeClass(mapContainer, "station-mode");
Â  Â  Â  Â  	L.DomUtil.removeClass(mapContainer, "track-mode");
Â  Â  Â  Â  	L.DomUtil.removeClass(mapContainer, "dismantle-station-mode");
Â  Â  Â  Â  	L.DomUtil.removeClass(mapContainer, "dismantle-line-mode");

Â  Â  Â  Â  	map.off("click", handleStationCreation);
Â  Â  Â  Â  	map.off("click", handleLineDismantle);

Â  Â  Â  Â  	if (drawingPolyline) map.removeLayer(drawingPolyline);
Â  Â  Â  Â  	drawingPolyline = null;
Â  Â  Â  Â  	lineCandidateNodes = [];

Â  Â  Â  Â  	Game.mode = newMode;

Â  Â  Â  Â  	document
Â  Â  Â  Â  		.querySelectorAll(".rail-ui-control button")
Â  Â  Â  Â  		.forEach((btn) => btn.classList.remove("active"));

Â  Â  Â  Â  	if (newMode === "station") {
Â  Â  Â  Â  		L.DomUtil.addClass(mapContainer, "station-mode");
Â  Â  Â  Â  		document.getElementById("btn-station-mode").classList.add("active");
Â  Â  Â  Â  		map.on("click", handleStationCreation);
Â  Â  Â  Â  	} else if (newMode === "track") {
Â  Â  Â  Â  		L.DomUtil.addClass(mapContainer, "track-mode");
Â  Â  Â  Â  		document.getElementById("btn-track-mode").classList.add("active");
Â  Â  Â  Â  	} else if (newMode === "dismantle-station") {
Â  Â  Â  Â  		L.DomUtil.addClass(mapContainer, "dismantle-station-mode");
Â  Â  Â  Â  		document
Â  Â  Â  Â  			.getElementById("btn-dismantle-station-mode")
Â  Â  Â  Â  			.classList.add("active");
Â  Â  Â  Â  	} else if (newMode === "dismantle-line") {
Â  Â  Â  Â  		L.DomUtil.addClass(mapContainer, "dismantle-line-mode");
Â  Â  Â  Â  		document
Â  Â  Â  Â  			.getElementById("btn-dismantle-line-mode")
Â  Â  Â  Â  			.classList.add("active");
Â  Â  Â  		map.on("click", handleLineDismantle);
Â  Â  Â  Â  	} else {
Â  Â  Â  Â  		document.getElementById("btn-station-mode").classList.add("active"); // ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã®å¼·èª¿
Â  Â  Â  Â  	}
Â  Â  Â  	
Â  Â  Â  Â  	// ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã«é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
Â  Â  Â  Â  	const trackTypeSelect = document.getElementById("track-type");
Â  Â  Â  Â  	if (trackTypeSelect) {
Â  Â  Â  Â  		trackTypeSelect.value = Game.currentTrackType;
Â  Â  Â  Â  	}
Â  Â  Â  }

Â  Â  Â  function updateVehicleBuyUI() {
Â  Â  Â  Â  	const container = document.getElementById("vehicle-buy-container");
Â  Â  Â  Â  	container.innerHTML = `<h4>ğŸš† è»Šä¸¡è³¼å…¥ãƒ»è·¯ç·šå‰²å½“</h4>`;

Â  Â  Â  Â  	if (Game.establishedLines.length === 0) {
Â  Â  Â  Â  		container.innerHTML += `<p>è·¯ç·šã‚’å»ºè¨­ã™ã‚‹ã¨è»Šä¸¡ãŒè³¼å…¥ã§ãã¾ã™ã€‚</p>`;
Â  Â  Â  Â  		return;
Â  Â  Â  Â  	}

Â  Â  Â  Â  	if (Object.keys(VehicleData).length === 0) {
Â  Â  Â  Â  		container.innerHTML += `<p>è»Šä¸¡ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ä¸­...</p>`;
Â  Â  Â  Â  		return;
Â  Â  Â  Â  	}

Â  Â  Â  Â  	const sortedVehicleKeys = Object.keys(VehicleData).sort(
Â  Â  Â  Â  		(a, b) =>
Â  Â  Â  Â  			VehicleData[a].purchaseMultiplier -
Â  Â  Â  Â  			VehicleData[b].purchaseMultiplier
Â  Â  Â  Â  	);

Â  Â  Â  Â  	sortedVehicleKeys.forEach((key) => {
Â  Â  Â  Â  		const data = VehicleData[key];
Â  Â  Â  Â  		const purchaseCost = VEHICLE_BASE_COST * data.purchaseMultiplier;

Â  Â  Â  Â  		const availableLines = Game.establishedLines.filter((line) => {
Â  Â  Â  Â  			const isLinear = data.name === "ãƒªãƒ‹ã‚¢";

Â  Â  Â  Â  			if (isLinear) return line.trackType === "linear";
Â  Â  Â  Â  			if (line.trackType === "linear") return false;

Â  Â  Â  Â  			return true;
Â  Â  Â  Â  		});

Â  Â  Â  Â  		const lineSelect = `<select id="line-select-${key}" style="width: 50%; margin-right: 5px;">
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  ${availableLines
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (line) =>
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<option value="${line.id}">Line ${line.id} (${line.trackType})</option>`
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  Â  .join("")}
Â  Â  Â  Â  				 Â  Â  Â  Â  </select>`;

Â  Â  Â  Â  		const disabled = availableLines.length === 0 ? "disabled" : "";

Â  Â  Â  Â  		container.innerHTML += `
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; align-items: center; margin-bottom: 5px;">
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="width: 100px; color: ${data.color};">${
Â  Â  Â  Â  			data.name
Â  Â  Â  Â  		}</span>
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small style="flex-grow: 1; margin-left: 10px;">${
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.maxSpeedKmH
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }km/h, Â¥${purchaseCost.toLocaleString()}</small>
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${lineSelect}
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="buyVehicle('${key}')" style="width: 45%;" ${disabled}>è³¼å…¥</button>
Â  Â  Â  Â  				 Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  				 Â  Â  Â  Â  `;
Â  Â  Â  Â  	});
Â  Â  Â  }

Â  Â  Â  window.buyVehicle = (vehicleKey) => {
Â  Â  Â  Â  	if (!socket) return alert("ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
Â  Â  Â  Â  	const lineSelect = document.getElementById(`line-select-${vehicleKey}`);
Â  Â  Â  Â  	if (!lineSelect || lineSelect.value === "") {
Â  Â  Â  Â  		alert("å‰²ã‚Šå½“ã¦ã‚‹è·¯ç·šã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
Â  Â  Â  Â  		return;
Â  Â  Â  Â  	}
Â  Â  Â  Â  	const lineId = lineSelect.value;

Â  Â  Â  Â  	socket.emit("buyVehicle", { lineId: lineId, vehicleKey: vehicleKey });
Â  Â  Â  };

Â  Â  Â  window.toggleAccordion = (contentId) => {
Â  Â  Â  Â  	const content = document.getElementById(contentId);
Â  Â  Â  Â  	const header = content.previousElementSibling;
Â  Â  Â  Â  	const icon = header.querySelector("span:last-child");

Â  Â  Â  Â  	content.classList.toggle("open");
Â  Â  Â  Â  	if (content.classList.contains("open")) {
Â  Â  Â  Â  		icon.textContent = "â–¼";
Â  Â  Â  Â  	} else {
Â  Â  Â  Â  		icon.textContent = "â–²";
Â  Â  Â  	}
Â  Â  Â  };

Â  Â  Â  window.handleLogin = handleLogin;
Â  Â  Â  window.toggleConstructionMode = toggleConstructionMode;
Â  Â  Â  window.finalizeLine = finalizeLine;
Â  Â  Â  window.Game = Game;

Â  Â  Â  document.addEventListener("DOMContentLoaded", () => {
Â  Â  Â  Â  	// 1. Leafletãƒãƒƒãƒ—ã®åˆæœŸåŒ–ã‚’æœ€åˆã«è¡Œã†
Â  Â  Â  Â  	// ğŸ’¡ ä¿®æ­£: worldCopyJump: true ã¨ noWrap: false ã‚’è¿½åŠ ã—ã€ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ©ãƒƒãƒ”ãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–
Â  Â  Â  Â  	map = L.map("map", {
Â  Â  Â  Â  		worldCopyJump: true, // ãƒãƒ¼ã‚«ãƒ¼ã‚„ãƒãƒªãƒ©ã‚¤ãƒ³ãŒãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ”ãƒ¼é–“ã§æ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
Â  Â  Â  Â  		noWrap: false // çµŒåº¦æ–¹å‘ã®ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ãŒæ˜ç¤º)
Â  Â  Â  Â  	}).setView([INITIAL_LAT, INITIAL_LNG], 13);
Â  Â  Â  Â  	
Â  Â  Â  Â  	L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
Â  Â  Â  Â  		attribution: "Â© OpenStreetMap contributors (Base)",
Â  Â  Â  		maxZoom: 19,
Â  Â  Â  Â  		noWrap: false // ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼å´ã§ã‚‚ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹
Â  Â  Â  Â  	}).addTo(map);
Â  Â  Â  Â  	
Â  Â  Â  Â  	L.tileLayer(
Â  Â  Â  Â  		"https://cyberjapandata.gsi.go.jp/xyz/dem5a_color/{z}/{x}/{y}.png",
Â  Â  Â  Â  		{ attribution: "å›½åœŸåœ°ç†é™¢", opacity: 0.5 }
Â  Â  Â  Â  	).addTo(map);

Â  Â  Â  Â  	// 2. UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ãƒãƒƒãƒ—ã«è¿½åŠ 
Â  Â  Â  Â  	const controlDiv = document.querySelector(".rail-ui-control");
Â  Â  Â  Â  	const controlHtml = controlDiv.innerHTML;
Â  Â  Â  Â  	controlDiv.remove();

Â  Â  Â  Â  	const constructControl = L.control({ position: "topleft" });
Â  Â  Â  Â  	constructControl.onAdd = function (map) {
Â  Â  Â  Â  		const div = L.DomUtil.create("div", "rail-ui-control");
Â  Â  Â  Â  		div.innerHTML = controlHtml;
Â  Â  Â  Â  		L.DomEvent.disableClickPropagation(div);
Â  Â  Â  Â  		
Â  Â  Â  Â  		// è¦ç´ ãŒDOMã«è¿½åŠ ã•ã‚ŒãŸç›´å¾Œã«é¸æŠå€¤ã‚’å¾©å…ƒ
Â  Â  Â  Â  		const trackTypeSelect = div.querySelector("#track-type");
Â  Â  Â  Â  		if (trackTypeSelect) {
Â  Â  Â  Â  			trackTypeSelect.value = Game.currentTrackType;
Â  Â  Â  Â  		}
Â  Â  Â  Â  		
Â  Â  Â  Â  		return div;
Â  Â  Â  Â  	};
Â  Â  Â  Â  	constructControl.addTo(map);

Â  Â  Â  Â  	// 3. å»ºè¨­ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸåŒ–
Â  Â  Â  Â  	toggleConstructionMode("idle");

Â  Â  Â  Â  	// 4. ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
Â  Â  Â  Â  	const savedUserId = getCookie("userId");
Â  Â  Â  Â  	if (savedUserId) {
Â  Â  Â  Â  		document.getElementById("username-input").value = savedUserId;
Â  Â  Â  Â  	}
Â  Â  Â  });
Â  Â  </script>
Â  </body>
</html>

