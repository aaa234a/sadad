
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>NIMBY Rail Clone - é‰„é“ï¼†èˆªç©ºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
      body {
        margin: 0;
      }
      #map {
        height: 100vh;
        width: 100%;
        background-color: white;
      }

      .rail-ui-control,
      #game-stats,
      #login-overlay,
      #ranking-panel,
      #chat-panel,
      #news-feed-panel {
        background-color: rgba(255, 255, 255, 0.95);
        padding: 10px;
        border: 2px solid #333;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        font-family: Arial, sans-serif;
        z-index: 1000;
        position: fixed;
      }

      /* ãƒ­ã‚°ã‚¤ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
      #login-overlay {
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
      }
      #login-panel {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        text-align: center;
      }

      /* UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£: ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
      .rail-ui-control {
        top: 10px;
        left: 10px;
        width: 300px;
        max-height: 85vh;
        overflow-y: auto;
      }

      #extend-line-panel {
        margin-top: 10px;
        padding: 8px;
        border: 1px dashed #666;
        background-color: rgba(240, 240, 240, 0.9);
        display: none;
        text-align: left;
        font-size: 0.9em;
      }

      .line-mode-hint {
        font-size: 0.85em;
        color: #444;
        margin: 4px 0 8px;
      }

      /* ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ‘ãƒãƒ« (å·¦ä¸‹) */
      #news-feed-panel {
        bottom: 10px;
        left: 10px;
        width: 300px;
        max-height: 200px;
        overflow-y: auto;
        font-size: 0.9em;
      }

      /* UIã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä½ç½® (å³ä¸Š) */
      #game-stats {
        top: 10px;
        right: 10px;
        width: 300px;
        line-height: 1.5;
      }

      /* ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ä½ç½® (å³ä¸‹) */
      #chat-panel {
        bottom: 10px;
        right: 10px;
        width: 300px;
        max-height: 240px;
      }

      /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‘ãƒãƒ«ä½ç½® (ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ã®ä¸Š) */
      #ranking-panel {
        bottom: 250px;
        right: 10px;
        width: 300px;
        max-height: 240px;
        overflow-y: auto;
      }

      /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ */
      .accordion-header {
        cursor: pointer;
        background-color: #f0f0f0;
        padding: 5px;
        border-bottom: 1px solid #ccc;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .accordion-content {
        padding-top: 10px;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }
      .accordion-content.open {
        max-height: none;
      }

      /* ãƒœã‚¿ãƒ³ãƒ»ã‚»ãƒ¬ã‚¯ãƒˆ */
      .rail-ui-control button,
      .rail-ui-control select,
      #loan-panel button {
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid #555;
        background-color: #f5f5f5;
        border-radius: 3px;
        margin: 2px 0;
        width: 100%;
        box-sizing: border-box;
      }
      .rail-ui-control button.active {
        background-color: #007bff !important;
        color: white;
        border-color: #0056b3;
      }
      .time-display {
        font-size: 1.2em;
        font-weight: bold;
        color: #0044bb;
        margin-bottom: 10px;
      }

      /* åˆ—è»Šã‚¢ã‚¤ã‚³ãƒ³ã®èª¿æ•´: ä¸¸ã‹ã‚‰é•·æ–¹å½¢ã«å¤‰æ›´ */
      .train-icon {
        width: 18px;
        height: 8px;
        border-radius: 2px;
        border: 2px solid #fff;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        transform: translate(-50%, -50%);
      }
      .station-icon {
        background-color: #000;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        cursor: pointer;
      }

      /* å‹•çš„ãªé§…ã‚¢ã‚¤ã‚³ãƒ³ã‚«ãƒ©ãƒ¼ */
      .station-icon.normal {
        background-color: #0044bb;
      }
      .station-icon.overload {
        background-color: #ff0000;
      }
      .station-icon.demand {
        background-color: #ffcc00;
      }

      /* ç©ºæ¸¯ã‚¢ã‚¤ã‚³ãƒ³ */
      .airport-icon {
        background-color: #007bff;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        cursor: pointer;
        text-align: center;
        line-height: 14px;
        font-size: 12px;
        color: white;
        font-weight: bold;
      }

      /* å‹•çš„ãªç©ºæ¸¯ã‚¢ã‚¤ã‚³ãƒ³ã‚«ãƒ©ãƒ¼ */
      .airport-icon.normal {
        background-color: #007bff;
      }
      .airport-icon.overload {
        background-color: #ff0000;
      }

      /* é£›è¡Œæ©Ÿã‚¢ã‚¤ã‚³ãƒ³ (å›è»¢å¯¾å¿œ) */
      .airplane-icon {
        width: 24px;
        height: 24px;
        background-color: #5bc0de;
        border-radius: 2px;
        border: 2px solid #fff;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        clip-path: polygon(
          50% 0%,
          60% 25%,
          100% 50%,
          60% 75%,
          50% 100%,
          40% 75%,
          0% 50%,
          40% 25%
        );
        transform: translate(-50%, -50%);
        transform-origin: 50% 50%;
      }

      /* è·¯ç·šè¨­å®šãƒ‘ãƒãƒ«å†…ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
      #line-config-panel label {
          display: inline-block;
          margin-top: 5px;
          font-size: 0.9em;
      }
      #line-config-panel input[type="range"] {
          margin-top: 0;
      }
      #line-config-panel button {
          width: 100%;
          padding: 5px;
      }


      .leaflet-container.station-mode,
      .leaflet-container.airport-mode {
        cursor: crosshair;
      }
      .leaflet-container.dismantle-station-mode .station-icon {
        border-color: #ff0000;
        cursor: crosshair;
      }
      .leaflet-container.dismantle-line-mode {
        cursor: crosshair;
      }

      #error-message,
      #info-message {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 3000;
        display: none;
      }
      #error-message {
        background-color: #ff4444;
        color: white;
      }
      #info-message {
        background-color: #44aaff;
        color: white;
      }

      /* ========================================================= */
      /* UIé‡ãªã‚Šé˜²æ­¢ã®ãŸã‚ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª */
      /* ========================================================= */
      @media (max-width: 650px) {
        .rail-ui-control,
        #game-stats,
        #ranking-panel,
        #chat-panel,
        #news-feed-panel {
          width: 95%;
          left: 2.5%;
          right: auto;
          position: relative;
          margin-bottom: 10px;
        }

        body {
          display: flex;
          flex-direction: column;
          align-items: center;
          padding-bottom: 260px;
        }

        #map {
          position: fixed;
          top: 0;
          left: 0;
          height: 100%;
          width: 100%;
          z-index: 0;
        }

        /* å»ºè¨­ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« (å·¦ä¸Š -> ä¸Šéƒ¨å…¨ä½“) */
        .rail-ui-control {
          top: 10px;
          max-height: 40vh;
          z-index: 1001;
        }

        /* çµ±è¨ˆæƒ…å ± (å³ä¸Š -> å»ºè¨­ã®ä¸‹) */
        #game-stats {
          top: auto;
          right: auto;
          z-index: 1001;
        }

        /* ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ‰ (å·¦ä¸‹ -> çµ±è¨ˆã®ä¸‹) */
        #news-feed-panel {
          top: auto;
          left: 2.5%;
          right: auto;
          z-index: 1001;
        }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¨ãƒãƒ£ãƒƒãƒˆã¯ç”»é¢ä¸‹éƒ¨ã«å›ºå®š */
        #ranking-panel,
        #chat-panel {
          position: fixed;
          width: 95%;
          left: 2.5%;
          right: auto;
          z-index: 1002;
        }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° (ãƒãƒ£ãƒƒãƒˆã®ä¸Š) */
        #ranking-panel {
          bottom: 130px;
          max-height: 120px;
        }

        /* ãƒãƒ£ãƒƒãƒˆ (æœ€ä¸‹éƒ¨) */
        #chat-panel {
          bottom: 10px;
          max-height: 120px;
        }

        #chat-messages {
          height: 50px !important;
        }
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="login-overlay">
      <div id="login-panel">
        <h2>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é‰„é“ï¼†èˆªç©ºã‚·ãƒ ã¸ã‚ˆã†ã“ã</h2>
        <p>
          ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å‚åŠ ã™ã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br /><small
            >ï¼ˆæ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä»»æ„ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ç™»éŒ²ã§ãã¾ã™ï¼‰</small
          >
        </p>
        <input
          type="text"
          id="username-input"
          placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å"
          style="padding: 10px; margin-bottom: 10px; width: 80%"
        />
        <input
          type="password"
          id="password-input"
          placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
          style="padding: 10px; margin-bottom: 10px; width: 80%"
        />
        <button onclick="handleLogin()" style="width: 80%">
          ãƒ­ã‚°ã‚¤ãƒ³ / å‚åŠ 
        </button>
      </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ çµ±è¨ˆ (å³ä¸Š) -->
    <div id="game-stats">
      <div class="accordion-header" onclick="toggleAccordion('stats-content')">
        <span>ğŸ“Š ã‚²ãƒ¼ãƒ çµ±è¨ˆãƒ»æ™‚é–“ <span id="stats-toggle-icon">â–¼</span></span>
      </div>
      <div id="stats-content" class="accordion-content open">
        <p class="time-display">
          æ—¥æ™‚: <span id="game-date-time">åŒæœŸä¸­...</span>
        </p>
        <p>å€é€Ÿ: <span id="time-scale-display">x60</span> (ã‚µãƒ¼ãƒãƒ¼åˆ¶å¾¡)</p>
        <hr />
        <h3>ğŸ’° çµŒå–¶çŠ¶æ³ (ã‚ãªãŸ)</h3>
        <p>è³‡é‡‘: <span id="money-display">Â¥0</span></p>
        <p>ç·è³‡ç”£: <span id="asset-display">Â¥0</span></p>
        <p>æœˆæ¬¡ç¶­æŒè²»: <span id="maint-cost-display">Â¥0</span></p>
        <p>æœˆæ¬¡è¿”æ¸ˆé¡: <span id="loan-repayment-display">Â¥0</span></p>
        <p>
          è»Šä¸¡æ•°: <span id="vehicle-count">0</span> | ã‚¿ãƒ¼ãƒŸãƒŠãƒ«æ•°:
          <span id="terminal-count">0</span>
        </p>
      </div>
    </div>

    <!-- ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ‘ãƒãƒ« (å·¦ä¸‹) -->
    <div id="news-feed-panel">
      <div class="accordion-header" onclick="toggleAccordion('news-content')">
        <span>ğŸ“° ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ‰ <span id="news-toggle-icon">â–¼</span></span>
      </div>
      <div
        id="news-content"
        class="accordion-content open"
        style="max-height: 150px; overflow-y: auto"
      >
        <ul id="news-list" style="list-style: none; padding: 0; margin: 0">
          <li>ã‚·ã‚¹ãƒ†ãƒ : ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</li>
        </ul>
      </div>
    </div>

    <!-- å»ºè¨­ãƒ»è»Šä¸¡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« (å·¦ä¸Š) -->
    <div class="rail-ui-control">
      <div
        class="accordion-header"
        onclick="toggleAccordion('control-content')"
      >
        <span>ğŸ› ï¸ å»ºè¨­ãƒ»è»Šä¸¡æ“ä½œ <span id="control-toggle-icon">â–¼</span></span>
      </div>
      <div id="control-content" class="accordion-content open">
        <div style="text-align: center; margin-bottom: 10px">
          <!-- èè³‡ãƒ‘ãƒãƒ« -->
          <hr style="margin: 10px 0; border: none; border-top: 2px solid #888" />
          <h3>ğŸ¦ éŠ€è¡Œèè³‡</h3>
          <div id="loan-panel">
            <p>ç¾åœ¨ã®å€Ÿå…¥: <span id="current-loan-display">Â¥0</span></p>
            <p>å€Ÿå…¥å¯èƒ½é¡: <span id="max-loan-display">Â¥0</span></p>
            <input
              type="number"
              id="loan-amount-input"
              placeholder="å€Ÿå…¥å¸Œæœ›é¡ (M)"
              style="width: 48%; display: inline-block"
            />
            <input
              type="number"
              id="loan-term-input"
              placeholder="æœŸé–“ (æœˆ)"
              style="width: 48%; display: inline-block"
            />
            <button onclick="requestLoan()">èè³‡ã‚’ç”³ã—è¾¼ã‚€</button>
          </div>

          <!-- å»ºè¨­ã‚³ã‚¹ãƒˆè©³ç´° -->
          <div
            id="construction-info"
            style="
              margin-top: 10px;
              padding: 5px;
              border: 1px solid #ccc;
              display: none;
            "
          >
            <b>å»ºè¨­äºˆå®š:</b>
            <p>è·é›¢: <span id="construction-distance">0.0 km</span></p>
            <p>æ¦‚ç®—ã‚³ã‚¹ãƒˆ: <span id="construction-cost">Â¥0</span></p>
            <p>åœ°å½¢è£œæ­£: <span id="construction-terrain">0%</span></p>
          </div>

          <!-- é‰„é“ã‚¤ãƒ³ãƒ•ãƒ© -->
          <hr
            style="margin: 10px 0; border: none; border-top: 2px solid #333"
          />
          <h3>ğŸš† é‰„é“ã‚¤ãƒ³ãƒ•ãƒ©</h3>
          <button
            id="btn-station-mode"
            onclick="toggleConstructionMode('station')"
          >
            ğŸ  é§…ãƒ¢ãƒ¼ãƒ‰ (Â¥50M)
          </button>
          <button id="btn-track-mode" onclick="toggleConstructionMode('track')">
            ğŸ›¤ï¸ è·¯ç·šãƒ¢ãƒ¼ãƒ‰
          </button>
          <button onclick="finalizeLine()" style="margin-top: 5px">
            âœ… è·¯ç·šã‚’ç¢ºå®š
          </button>

          <!-- èˆªç©ºã‚¤ãƒ³ãƒ•ãƒ© -->
          <hr
            style="margin: 10px 0; border: none; border-top: 2px solid #007bff"
          />
          <h3>âœˆï¸ èˆªç©ºã‚¤ãƒ³ãƒ•ãƒ©</h3>
          <button
            id="btn-airport-mode"
            onclick="toggleConstructionMode('airport')"
          >
            âœˆï¸ ç©ºæ¸¯ãƒ¢ãƒ¼ãƒ‰ (Â¥500M)
          </button>
          <button
            id="btn-air-route-mode"
            onclick="toggleConstructionMode('air-route')"
          >
            ğŸ›¬ èˆªç©ºè·¯ç·šãƒ¢ãƒ¼ãƒ‰
          </button>
          <button onclick="finalizeAirRoute()" style="margin-top: 5px">
            âœ… èˆªç©ºè·¯ç·šã‚’ç¢ºå®š
          </button>

          <hr
            style="margin: 10px 0; border: none; border-top: 1px solid #ccc"
          />

          <!-- è§£ä½“ãƒ¢ãƒ¼ãƒ‰ -->
          <button
            id="btn-dismantle-station-mode"
            onclick="toggleConstructionMode('dismantle-station')"
            style="background-color: #ffc0cb"
          >
            ğŸ’¥ ã‚¿ãƒ¼ãƒŸãƒŠãƒ«è§£ä½“ãƒ¢ãƒ¼ãƒ‰
          </button>
          <button
            id="btn-dismantle-line-mode"
            onclick="toggleConstructionMode('dismantle-line')"
            style="background-color: #ffc0cb"
          >
            ğŸ’£ è·¯ç·š/èˆªç©ºè·¯ç·šè§£ä½“ãƒ¢ãƒ¼ãƒ‰
          </button>

          <hr
            style="margin: 10px 0; border: none; border-top: 1px solid #ccc"
          />

          <button onclick="toggleConstructionMode('idle')">
            âŒ å»ºè¨­ã‚­ãƒ£ãƒ³ã‚»ãƒ«/ã‚¢ã‚¤ãƒ‰ãƒ«
          </button>

          <hr
            style="margin: 10px 0; border: none; border-top: 1px solid #ccc"
          />

          <!-- è·¯ç·šå»¶é•·ãƒ‘ãƒãƒ« -->
          <div id="extend-line-panel">
            <strong>è·¯ç·šå»¶é•·ãƒ¢ãƒ¼ãƒ‰</strong>
            <p class="line-mode-hint" id="extend-line-hint">
              å»¶é•·ã—ãŸã„è·¯ç·šã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
            </p>
            <button
              id="btn-extend-line-select"
              onclick="toggleConstructionMode('extend-line')"
              style="margin-bottom: 5px"
            >
              è·¯ç·šã‚’é¸æŠ
            </button>
            <button
              id="btn-extend-line-confirm"
              onclick="confirmLineExtension()"
              disabled
            >
              âœ… å»¶é•·ã‚’ç¢ºå®š
            </button>
            <button
              id="btn-extend-line-cancel"
              onclick="cancelLineExtension()"
              disabled
            >
              âœ– å»¶é•·ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button
              id="btn-extend-line-delete"
              onclick="deleteTransientExtension()"
              disabled
            >
              ğŸ§¹ ä»®å»¶é•·ã‚’å‰Šé™¤
            </button>
          </div>

          <label
            style="display: block; margin-bottom: 5px; font-weight: bold"
            >ç·šè·¯/è·¯ç·šã‚¿ã‚¤ãƒ—:</label
          >
          <select id="track-type" onchange="Game.currentTrackType = this.value">
            <option value="single">å˜ç·š (x1.0)</option>
            <option value="double">è¤‡ç·š (x1.8)</option>
            <option value="linear">ãƒªãƒ‹ã‚¢å°‚ç”¨ (x5.0)</option>
            <option value="tram">è·¯é¢é›»è»Šå°‚ç”¨ (x0.8)</option>
            <option value="air">èˆªç©ºè·¯ç·š (å»ºè¨­è²»å®‰)</option>
          </select>

          <!-- è·¯ç·šç®¡ç†ãƒ»è¨­å®šãƒ‘ãƒãƒ« -->
          <hr style="margin: 10px 0; border: none; border-top: 2px solid #333" />
          <h3>âš™ï¸ è·¯ç·šç®¡ç†ãƒ»è¨­å®š</h3>
          <div id="line-management-container">
              <!-- è·¯ç·šãƒªã‚¹ãƒˆãŒJSã§æŒ¿å…¥ã•ã‚Œã‚‹ -->
          </div>
          <div id="line-config-panel" style="display: none; border: 1px solid #007bff; padding: 10px; margin-top: 10px; text-align: left;">
              <h4>è·¯ç·š L<span id="config-line-id"></span> è¨­å®š</h4>
              
              <!-- é‹è³ƒè¨­å®š -->
              <label for="fare-multiplier-input" style="font-weight: bold; display: block; margin-top: 10px;">é‹è³ƒå€ç‡ (<span id="current-fare-multiplier">1.00</span>å€):</label>
              <input type="range" id="fare-multiplier-input" min="0.5" max="3.0" step="0.05" oninput="updateFareDisplay(this.value)" style="width: 100%;">
              <button onclick="setLineFare()" style="margin-top: 5px;">é‹è³ƒã‚’é©ç”¨</button>
              
              <!-- ã‚µãƒ¼ãƒ“ã‚¹è¨­å®š -->
              <h5 style="margin-top: 15px; margin-bottom: 5px;">ã‚µãƒ¼ãƒ“ã‚¹æä¾› (äººæ°—åº¦/ç¶­æŒè²»)</h5>
              <div id="service-options-container">
                  <!-- ã‚µãƒ¼ãƒ“ã‚¹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒJSã§æŒ¿å…¥ã•ã‚Œã‚‹ -->
              </div>
          </div>
        </div>
        <div id="vehicle-buy-container"></div>
      </div>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ« (å³ä¸‹) -->
    <div id="chat-panel">
      <div class="accordion-header" onclick="toggleAccordion('chat-content')">
        <span>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ <span id="chat-toggle-icon">â–¼</span></span>
      </div>
      <div id="chat-content" class="accordion-content open">
        <div
          id="chat-messages"
          style="
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
            margin-bottom: 5px;
            background-color: #f9f9f9;
          "
        >
          <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </div>
        <input
          type="text"
          id="chat-input"
          placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
          maxlength="200"
          style="width: 70%; padding: 5px; box-sizing: border-box"
        />
        <button
          onclick="sendMessage()"
          style="width: 25%; margin-left: 5px; padding: 5px; box-sizing: border-box"
        >
          é€ä¿¡
        </button>
      </div>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‘ãƒãƒ« (ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ã®ä¸Š) -->
    <div id="ranking-panel">
      <div
        class="accordion-header"
        onclick="toggleAccordion('ranking-content')"
      >
        <span
          >ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚° (ç·è³‡ç”£ãƒ™ãƒ¼ã‚¹)
          <span id="ranking-toggle-icon">â–¼</span></span
        >
      </div>
      <div id="ranking-content" class="accordion-content open">
        <ol id="ranking-list">
          <li>ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸä¸­...</li>
        </ol>
      </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé ˜åŸŸ -->
    <div id="error-message" style="display: none"></div>
    <div id="info-message" style="display: none"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
      // =========================================================
      // A. ã‚²ãƒ¼ãƒ å®šæ•°ã¨çŠ¶æ…‹ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´)
      // =========================================================
      const INITIAL_LAT = 35.681236;
      const INITIAL_LNG = 139.767125;
      const STATION_COST = 50000000;
      const AIRPORT_COST = 500000000;
      const VEHICLE_BASE_COST = 8000000;
      const AIRPLANE_BASE_COST = 50000000;
      
      let SERVICE_SETTINGS = {}; // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹

      let VehicleData = {};
      let map;

      const Game = {
        userId: null,
        money: 0,
        totalConstructionCost: 0,
        currentLoan: 0,
        monthlyRepayment: 0,
        establishedLines: [],
        allLines: {},
        stations: [],
        airports: [],
        vehicles: [],
        allVehicleMarkers: {},
        mode: "idle",
        currentTrackType: "single",

        _lastLineCount: 0,
        _lastVehicleCount: 0,
        
        // è·¯ç·šå»¶é•·ç”¨çŠ¶æ…‹
        extendLine: {
            active: false,
            lineId: null,
            lineData: null,
            isExtendStart: null, // true: å§‹ç‚¹ã‹ã‚‰å»¶é•·, false: çµ‚ç‚¹ã‹ã‚‰å»¶é•·
            startTerminal: null, // æ—¢å­˜è·¯ç·šã®ç«¯ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            extensionNodes: [],  // è¿½åŠ ã™ã‚‹ä¸­é–“/çµ‚ç‚¹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚¹ãƒˆ
            transientPolyline: null,
        },

        updateStats(data) {
          this.money = data.money !== undefined ? data.money : this.money;
          this.totalConstructionCost =
            data.totalConstructionCost !== undefined
              ? data.totalConstructionCost
              : this.totalConstructionCost;
          this.currentLoan = data.currentLoan !== undefined ? data.currentLoan : this.currentLoan;
          this.monthlyRepayment = data.monthlyRepayment !== undefined ? data.monthlyRepayment : this.monthlyRepayment;
          this.establishedLines =
            data.establishedLines !== undefined
              ? data.establishedLines
              : this.establishedLines;
          this.vehicles =
            data.vehicles !== undefined ? data.vehicles : this.vehicles;

          if (data.stations || data.airports) this.drawTerminals(data.stations, data.airports);

          this.updateFinancialUI();
          updateLineManagementUI();
        },

        updateFinancialUI() {
            // è³‡ç”£è¨ˆç®— (ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚¸ãƒƒã‚¯ã«åˆã‚ã›ã‚‹ãŸã‚ã€è»Šä¸¡è³‡ç”£ã‚’æ¨å®š)
            let totalVehicleAsset = 0;
            this.vehicles.forEach(v => {
                const data = VehicleData[v.dataKey];
                if (!data) return;
                const baseCost = data.category === 'air' ? AIRPLANE_BASE_COST : VEHICLE_BASE_COST;
                totalVehicleAsset += baseCost * data.purchaseMultiplier * (v.formationSize || 1);
            });
            
            // ç·è³‡ç”£ = è³‡é‡‘ + å»ºè¨­æŠ•è³‡é¡ * 70% + è»Šä¸¡è³‡ç”£ * 30% - è² å‚µ
            const totalAsset =
                this.money +
                this.totalConstructionCost * 0.7 +
                totalVehicleAsset * 0.3 -
                this.currentLoan; 
                
            document.getElementById("money-display").textContent = `Â¥${Math.round(
                this.money
            ).toLocaleString()}`;
            document.getElementById("asset-display").textContent = `Â¥${Math.round(
                totalAsset
            ).toLocaleString()}`;
            document.getElementById("vehicle-count").textContent =
                this.vehicles.length;
            document.getElementById("current-loan-display").textContent = `Â¥${Math.round(
                this.currentLoan
            ).toLocaleString()}`;
            document.getElementById("loan-repayment-display").textContent = `Â¥${Math.round(
                this.monthlyRepayment
            ).toLocaleString()}`;
            
            // èè³‡å¯èƒ½é¡ã®æ›´æ–° 
            const maxLoan = Math.max(0, totalAsset * 0.5 - this.currentLoan);
            document.getElementById("max-loan-display").textContent = `Â¥${Math.round(maxLoan).toLocaleString()}`;
        },

        updateGlobalStats(data) {
          const gameTime = new Date(data.time);
          document.getElementById("game-date-time").textContent =
            this.formatDateTime(gameTime);
          document.getElementById(
            "time-scale-display"
          ).textContent = `x${data.globalStats.timeScale}`;
          document.getElementById("maint-cost-display").textContent = `Â¥${(
            data.globalStats.lastMonthlyMaintenance || 0
          ).toLocaleString()}`;
          document.getElementById("terminal-count").textContent =
            data.globalStats.stationsCount + data.globalStats.airportsCount;
            
          // ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ‰ã®æ›´æ–°
          if (data.globalStats.news) {
              this.addNewsItem(data.globalStats.news);
          }
            
          this.updateFinancialUI();
        },

        formatDateTime(date) {
          const year = date.getFullYear();
          const month = date.getMonth() + 1;
          const day = date.getDate();
          const hour = date.getHours().toString().padStart(2, "0");
          return `${year}å¹´${month}æœˆ${day}æ—¥ ${hour}æ™‚`;
        },
        
        addNewsItem(message) {
            const newsList = document.getElementById('news-list');
            const li = document.createElement('li');
            const date = new Date();
            const timeString = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            li.innerHTML = `<small style="color: #888;">[${timeString}]</small> ${message}`;
            
            if (newsList.firstChild) {
                newsList.insertBefore(li, newsList.firstChild);
            } else {
                newsList.appendChild(li);
            }
            
            while (newsList.children.length > 10) {
                newsList.removeChild(newsList.lastChild);
            }
        },

        drawTerminals(stations, airports) {
          this.stations.forEach((s) => s.markers.forEach(m => map.removeLayer(m)));
          this.stations = [];
          
          this.airports.forEach((a) => a.markers.forEach(m => map.removeLayer(m)));
          this.airports = [];

          stations.forEach(
            (s) =>
              new Station(
                s.id,
                { lat: s.latlng[0], lng: s.latlng[1] },
                map,
                s.ownerId,
                s.type, 
                s.capacity,
                s.name, 
                s.demand,
                s.lineConnections,
                s.isOverloaded, 
                s.isDemandHigh 
              )
          );
          
          airports.forEach(
            (a) =>
              new Airport(
                a.id,
                { lat: a.latlng[0], lng: a.latlng[1] },
                map,
                a.ownerId,
                a.type, 
                a.capacity,
                a.name,
                a.lineConnections,
                a.isOverloaded 
              )
          );
        },

        drawLines(lines) {
          Object.values(this.allLines).forEach((polylines) => {
              polylines.forEach(p => map.removeLayer(p));
          });
          this.allLines = {};
          lines.forEach((line) => this.drawLine(line));
        },

        drawLine(line) {
          let weight = 8;
          let dashArray = null;
          let color = line.color;

          if (line.trackType === "double") weight = 12;
          else if (line.trackType === "linear") weight = 15;
          else if (line.trackType === "tram") weight = 6;
          else if (line.trackType === "air") {
              weight = 2;
              color = '#007bff';
              dashArray = '5, 10'; 
          }

          const isMyLine = line.ownerId === Game.userId;
          const finalStyle = {
            color: color,
            weight: isMyLine ? weight : weight * 0.7, 
            opacity: isMyLine ? 1 : 0.7, 
            lineCap: "round",
            dashArray: dashArray
          };
          
          const longitudeOffsets = [-360, 0, 360];
          const polylines = [];

          longitudeOffsets.forEach((offset) => {
            const offsetCoords = line.coords.map(coord => 
                L.latLng(coord[0], coord[1] + offset)
            );
            
            const polyline = L.polyline(offsetCoords, finalStyle).addTo(map);
            
            // è·¯ç·šå»¶é•·ãƒ¢ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
            if (isMyLine) {
                polyline.on('click', (e) => {
                    if (Game.mode === 'extend-line') {
                        handleLineSelectionForExtension(line, e);
                        L.DomEvent.stopPropagation(e);
                    }
                });
            }
            
            polylines.push(polyline);
          });
          
          this.allLines[line.id] = polylines;
        },
      };

      let socket;
      let drawingPolyline = null;
      let lineCandidateNodes = [];
      let currentConstructionCost = 0;
      let currentConstructionDistance = 0;

      // =========================================================
      // B. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¯ãƒ©ã‚¹å®šç¾©
      // =========================================================

      function getTerminalIconStyle(terminal, isAirport) {
        let baseClass = isAirport ? "airport-icon" : "station-icon";
        let colorClass = "normal";

        if (terminal.ownerId !== Game.userId) {
            return baseClass;
        }

        if (terminal.isOverloaded) {
            colorClass = "overload"; 
        } else if (terminal.isDemandHigh && !isAirport) {
            colorClass = "demand"; 
        }
        
        return `${baseClass} ${colorClass}`;
      }

      class Station {
        constructor(id, latlng, map, ownerId, type = 'Small', capacity = 3, name, demand, lineConnections = [], isOverloaded = false, isDemandHigh = false) {
          this.id = id;
          this.latlng = latlng;
          this.ownerId = ownerId;
          this.name = name; 
          this.type = type; 
          this.capacity = capacity; 
          this.demand = demand; 
          this.lineConnections = lineConnections; 
          this.isAirport = false;
          this.isOverloaded = isOverloaded; 
          this.isDemandHigh = isDemandHigh; 
          this.markers = []; 

          this.drawMarkers(map);
          Game.stations.push(this);
        }
        
        drawMarkers(map) {
            this.markers.forEach(m => map.removeLayer(m));
            this.markers = [];

            const iconClass = getTerminalIconStyle(this, false);
            
            const stationIcon = L.divIcon({
                className: iconClass,
                style: `background-color: ${this.ownerId === Game.userId ? '' : '#FF0000'};`,
            });
            
            const popupContent = this.generatePopupContent();
            const longitudeOffsets = [-360, 0, 360];

            longitudeOffsets.forEach((offset) => {
                const offsetLatLng = L.latLng(this.latlng.lat, this.latlng.lng + offset);
                const marker = L.marker(offsetLatLng, {
                    icon: stationIcon,
                    title: this.name, 
                }).addTo(map);

                marker.bindPopup(popupContent);
                
                marker.on("click", (e) => {
                    handleTerminalClick(this);
                    L.DomEvent.stopPropagation(e);
                    if (e.originalEvent) {
                        e.originalEvent.stopPropagation();
                    }
                });
                
                this.markers.push(marker);
            });

            this.marker = this.markers[1]; 
        }

        generatePopupContent() {
            let popupContent = `<b>ğŸš† é§…: ${this.name} (ID: ${this.id})</b><br>Owner: ${this.ownerId}`;
            popupContent += `<br>ç¨®é¡: ${this.type} (å®¹é‡: ${this.capacity}åˆ—è»Š)`;
            
            if (this.isOverloaded) {
                popupContent += `<br><span style="color: red; font-weight: bold;">âš ï¸ å®¹é‡è¶…é!</span>`;
            }
            
            if (this.lineConnections && this.lineConnections.length > 0) {
                popupContent += `<hr><b>æ¥ç¶šè·¯ç·š: ${this.lineConnections.length}æœ¬</b>`;
            } else {
                popupContent += `<br>æ¥ç¶šè·¯ç·š: ãªã—`;
            }
            
            if (this.demand) {
                popupContent += `<hr><b>ğŸ“Š éœ€è¦</b><br>`;
                popupContent += `æ—…å®¢: ${this.demand.passenger.toLocaleString()}äºº/æœˆ<br>`;
                popupContent += `è²¨ç‰©: ${this.demand.freight.toLocaleString()}t/æœˆ`;
            }
            
            if (this.ownerId === Game.userId) {
                const isMedium = this.type === 'Medium';
                const isLarge = this.type === 'Large';

                popupContent += `<hr>
                  <button onclick="upgradeStation(${this.id}, 'Medium')" ${isMedium || isLarge ? 'disabled' : ''} style="width: 100%; margin-bottom: 5px;">ä¸­è¦æ¨¡ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ (Â¥50M)</button>
                  <button onclick="upgradeStation(${this.id}, 'Large')" ${isLarge ? 'disabled' : ''} style="width: 100%;">å¤§è¦æ¨¡ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ (${isMedium ? 'Â¥100M' : 'Â¥150M'})</button>`;
                
                popupContent += `<hr>
                  <label for="rename-input-${this.id}">é§…åå¤‰æ›´:</label>
                  <input type="text" id="rename-input-${this.id}" value="${this.name}" maxlength="20" style="width: 100%; margin: 5px 0;">
                  <button onclick="renameTerminalClient(${this.id}, false)" style="width: 100%;">é§…åã‚’å¤‰æ›´</button>`;
            }
            return popupContent;
        }

        updatePopup() {
            this.drawMarkers(map);
        }
      }

      class Airport {
        constructor(id, latlng, map, ownerId, type = 'Small', capacity = 5, name, lineConnections = [], isOverloaded = false) {
          this.id = id;
          this.latlng = latlng;
          this.ownerId = ownerId;
          this.name = name; 
          this.type = type; 
          this.capacity = capacity; 
          this.lineConnections = lineConnections; 
          this.isAirport = true;
          this.isOverloaded = isOverloaded;
          this.markers = []; 

          this.drawMarkers(map);
          Game.airports.push(this);
        }

        drawMarkers(map) {
            this.markers.forEach(m => map.removeLayer(m));
            this.markers = [];

            const iconClass = getTerminalIconStyle(this, true);
            
            const airportIcon = L.divIcon({
                className: iconClass,
                html: 'âœˆï¸',
                style: `background-color: ${this.ownerId === Game.userId ? '' : '#FF0000'};`,

            });
            
            const popupContent = this.generatePopupContent();
            const longitudeOffsets = [-360, 0, 360];

            longitudeOffsets.forEach((offset) => {
                const offsetLatLng = L.latLng(this.latlng.lat, this.latlng.lng + offset);
                const marker = L.marker(offsetLatLng, {
                    icon: airportIcon,
                    title: this.name, 
                }).addTo(map);

                marker.bindPopup(popupContent);
                
                marker.on("click", (e) => {
                    handleTerminalClick(this);
                    L.DomEvent.stopPropagation(e);
                    if (e.originalEvent) {
                        e.originalEvent.stopPropagation();
                    }
                });
                
                this.markers.push(marker);
            });

            this.marker = this.markers[1]; 
        }

        generatePopupContent() {
            let popupContent = `<b>âœˆï¸ ç©ºæ¸¯: ${this.name} (ID: ${this.id})</b><br>Owner: ${this.ownerId}`;
            popupContent += `<br>ç¨®é¡: ${this.type} (å®¹é‡: ${this.capacity}æ©Ÿ)`;
            
            if (this.isOverloaded) {
                popupContent += `<br><span style="color: red; font-weight: bold;">âš ï¸ å®¹é‡è¶…é!</span>`;
            }
            
            if (this.lineConnections && this.lineConnections.length > 0) {
                popupContent += `<hr><b>æ¥ç¶šè·¯ç·š: ${this.lineConnections.length}æœ¬</b>`;
            } else {
                popupContent += `<br>æ¥ç¶šè·¯ç·š: ãªã—`;
            }
            
            if (this.ownerId === Game.userId) {
                popupContent += `<hr>ç©ºæ¸¯ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™ã€‚`;
                
                popupContent += `<hr>
                  <label for="rename-input-${this.id}">ç©ºæ¸¯åå¤‰æ›´:</label>
                  <input type="text" id="rename-input-${this.id}" value="${this.name}" maxlength="20" style="width: 100%; margin: 5px 0;">
                  <button onclick="renameTerminalClient(${this.id}, true)" style="width: 100%;">ç©ºæ¸¯åã‚’å¤‰æ›´</button>`;
            }
            return popupContent;
        }

        updatePopup() {
            this.drawMarkers(map);
        }
      }

      // =========================================================
      // C. ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã¨èªè¨¼
      // =========================================================

      function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) === " ") c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0)
            return c.substring(nameEQ.length, c.length);
        }
        return null;
      }

      async function handleLogin() {
        const username = document.getElementById("username-input").value.trim();
        const password = document.getElementById("password-input").value.trim();

        if (username.length < 3 || password.length === 0) {
          alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        try {
          const response = await fetch("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: username, password: password }),
          });
          const data = await response.json();

          if (data.success) {
            Game.userId = data.userId;
            document.getElementById("login-overlay").style.display = "none";
            connectSocket(Game.userId);
          } else {
            alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + data.message);
          }
        } catch (error) {
          console.error("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", error);
          alert("ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      }

      let currentConfigLineId = null;

      function connectSocket(userId) {
        socket = io();

        socket.on("connect", () => {
          socket.emit("login", { userId: userId });
        });

        socket.on("initialState", (data) => {
          VehicleData = data.vehicleData;
          SERVICE_SETTINGS = data.serviceSettings || {}; // ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
          Game.updateStats(data);
          
          if (data.allLines) {
            Game.drawLines(data.allLines);
          }
          
          updateVehicleBuyUI();
          Game._lastLineCount = data.establishedLines ? data.establishedLines.length : 0;
          Game._lastVehicleCount = data.vehicles ? data.vehicles.length : 0;
        });

        socket.on("updateUserState", (data) => {
          Game.updateStats(data);
          
          const currentLineCount = data.establishedLines ? data.establishedLines.length : Game._lastLineCount;
          const currentVehicleCount = data.vehicles ? data.vehicles.length : Game._lastVehicleCount;

          if (currentLineCount !== Game._lastLineCount || currentVehicleCount !== Game._lastVehicleCount) {
              updateVehicleBuyUI();
              Game._lastLineCount = currentLineCount;
              Game._lastVehicleCount = currentVehicleCount;
          }
        });

        socket.on("gameUpdate", (data) => {
          Game.updateGlobalStats(data);
          updateVehiclePositions(data.vehiclePositions);
        });

        socket.on("rankingUpdate", (ranking) => {
          updateRankingUI(ranking);
        });

        socket.on("terminalUpdate", (data) => {
            const terminalArray = data.isAirport ? Game.airports : Game.stations;
            const terminal = terminalArray.find(t => t.id === data.id);
            
            if (terminal) {
                if (data.isOverloaded !== undefined) terminal.isOverloaded = data.isOverloaded;
                if (data.isDemandHigh !== undefined) terminal.isDemandHigh = data.isDemandHigh;
                if (data.lineConnections !== undefined) terminal.lineConnections = data.lineConnections;
                if (data.demand !== undefined) terminal.demand = data.demand;
                
                terminal.updatePopup();
            }
        });

        socket.on("stationBuilt", (data) => {
          new Station(data.id, { lat: data.latlng[0], lng: data.latlng[1] }, map, data.ownerId, data.type, data.capacity, data.name, data.demand, data.lineConnections || []); 
          Game.updateGlobalStats({ globalStats: { stationsCount: Game.stations.length, airportsCount: Game.airports.length } });
        });
        
        socket.on("airportBuilt", (data) => {
          new Airport(data.id, { lat: data.latlng[0], lng: data.latlng[1] }, map, data.ownerId, data.type, data.capacity, data.name, data.lineConnections || []); 
          Game.updateGlobalStats({ globalStats: { stationsCount: Game.stations.length, airportsCount: Game.airports.length } });
        });
        
        socket.on("stationUpgraded", (data) => {
          const station = Game.stations.find(s => s.id === data.id);
          if (station) {
              station.type = data.type;
              station.capacity = data.capacity;
              station.updatePopup();
          }
        });
        
        socket.on("terminalRenamed", (data) => {
            let terminal;
            if (data.isAirport) {
                terminal = Game.airports.find(s => s.id === data.id);
            } else {
                terminal = Game.stations.find(s => s.id === data.id);
            }
            
            if (terminal) {
                terminal.name = data.newName;
                terminal.updatePopup(); 
            }
        });

        socket.on("lineBuilt", (data) => {
          Game.drawLine(data);
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®establishedLinesã¯updateUserStateã§æ›´æ–°ã•ã‚Œã‚‹ãŒã€å³æ™‚åæ˜ ã®ãŸã‚æ‰‹å‹•ã§è¿½åŠ 
          if (data.ownerId === Game.userId) {
              Game.establishedLines.push(data);
              Game.updateLineManagementUI();
          }
        });
        
        socket.on("lineUpdated", (data) => {
            // æ—¢å­˜ã®è·¯ç·šã‚’å‰Šé™¤/å†æç”»
            if (Game.allLines[data.id]) {
                Game.allLines[data.id].forEach(p => map.removeLayer(p));
                delete Game.allLines[data.id];
            }
            Game.drawLine(data);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®establishedLinesã‚’æ›´æ–°
            const line = Game.establishedLines.find(l => l.id === data.id);
            if (line) {
                // æ—¢å­˜ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°
                Object.assign(line, data);

                // é‹è³ƒã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–°
                if (data.fareMultiplier !== undefined) line.fareMultiplier = data.fareMultiplier;
                if (data.services !== undefined) line.services = data.services;
            }
            
            // UIæ›´æ–°
            Game.updateLineManagementUI(); 
            if (currentConfigLineId === data.id) {
                // è¨­å®šãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯å†æç”»
                showLineConfigPanel(data.id); 
            }
        });

        socket.on("lineDismantled", (data) => {
          if (Game.allLines[data.lineId]) {
            Game.allLines[data.lineId].forEach(p => map.removeLayer(p));
            delete Game.allLines[data.lineId];
          }
          Game.establishedLines = Game.establishedLines.filter(l => l.id !== data.lineId);
          Game.updateLineManagementUI();
        });

        socket.on("stationDismantled", (data) => {
          let terminalArray = data.isAirport ? Game.airports : Game.stations;
          
          const terminalIndex = terminalArray.findIndex(
            (s) => s.id === data.terminalId
          );
          if (terminalIndex !== -1) {
            terminalArray[terminalIndex].markers.forEach(m => map.removeLayer(m));
            terminalArray.splice(terminalIndex, 1);
          }
          Game.updateGlobalStats({ globalStats: { stationsCount: Game.stations.length, airportsCount: Game.airports.length } });
        });

        socket.on("error", (message) => {
          const errorDiv = document.getElementById("error-message");
          errorDiv.textContent = message;
          errorDiv.style.display = "block";
          setTimeout(() => {
            errorDiv.style.display = "none";
          }, 5000);
        });

        socket.on("info", (message) => {
          const infoDiv = document.getElementById("info-message");
          infoDiv.textContent = message;
          infoDiv.style.display = "block";
          setTimeout(() => {
            infoDiv.style.display = "none";
          }, 5000);
        });
        
        socket.on("chatHistory", (history) => {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = ''; 
            history.forEach(msg => {
                appendChatMessage(msg.userId, msg.message, msg.timestamp);
            });
        });

        socket.on("newMessage", (data) => {
            appendChatMessage(data.userId, data.message, data.timestamp);
        });
      }

function updateVehiclePositions(vehiclePositions) {
  // çµŒåº¦ã‚’ã‚ªãƒ•ã‚»ãƒƒãƒˆã—ã¦ã€åœ°å›³ã‚’æ¨ªæ–¹å‘ã«ç¹‹ã’ã‚‹ãŸã‚ã®è¨­å®šï¼ˆä¾‹: -360, 0, +360ï¼‰
  const longitudeOffsets = [-360, 0, 360];
  const existingVehicleIds = new Set(Object.keys(Game.allVehicleMarkers));

  // å„è»Šä¸¡ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
  vehiclePositions.forEach((vehicle) => {
    // ======= å®‰å…¨ãƒã‚§ãƒƒã‚¯ ==========
    if (
      !Array.isArray(vehicle.latlng) ||
      vehicle.latlng.length !== 2 ||
      vehicle.latlng[0] == null ||
      vehicle.latlng[1] == null
    ) {
      console.warn(`è»Šä¸¡ID ${vehicle.id} ã®ä½ç½®æƒ…å ±ãŒä¸æ­£ã§ã™:`, vehicle.latlng);
      return;
    }
    // ================================

    const latlng = L.latLng(vehicle.latlng[0], vehicle.latlng[1]);
    existingVehicleIds.delete(vehicle.id.toString());

    // è»Šä¸¡ã”ã¨ã®ãƒãƒ¼ã‚«ãƒ¼ç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç¢ºä¿
    if (!Game.allVehicleMarkers[vehicle.id]) {
      Game.allVehicleMarkers[vehicle.id] = { original: null, copies: [] };
    }

    const markerData = Game.allVehicleMarkers[vehicle.id];

    // è»Šä¸¡ã®ç¨®é¡ã«ã‚ˆã£ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’åˆ†ã‘ã‚‹
    const isAir = vehicle.category === "air";
    const iconClass = isAir ? "airplane-icon" : "train-icon";

    // å›è»¢è§’åº¦ï¼ˆé£›è¡Œæ©Ÿãªã©ï¼‰
    const rotationAngle = vehicle.rotation !== undefined ? vehicle.rotation : 0;

    // ä¸­å¿ƒä½ç½®ã¨å›è»¢ã‚’ä¸¡æ–¹åæ˜ ã™ã‚‹ CSS
    const rotationStyle = `transform: translate(-50%, -50%)${
      rotationAngle ? ` rotate(${rotationAngle}deg)` : ""
    };`;

    // è¡¨ç¤ºã‚¢ã‚¤ã‚³ãƒ³ä½œæˆ
    const markerIcon = L.divIcon({
      className: iconClass,
      style: `background-color: ${vehicle.color}; border-color: ${
        vehicle.owner === Game.userId ? "yellow" : "white"
      }; ${rotationStyle}`,
    });

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ä¸­èº«
    const popupContent = `${
      isAir ? "âœˆï¸" : "ğŸš†"
    } è»Šä¸¡ #${vehicle.id} (Owner: ${vehicle.owner}) - Status: ${
      vehicle.status || "Running"
    } (ç·¨æˆæ•°: ${vehicle.formationSize || 1})`;

    // 3ã¤ã®çµŒåº¦ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆ-360, 0, +360ï¼‰ãã‚Œãã‚Œã«ãƒãƒ¼ã‚«ãƒ¼ã‚’é…ç½®
    longitudeOffsets.forEach((offset, index) => {
      // å¿µã®ãŸã‚ latlng å†ãƒã‚§ãƒƒã‚¯ï¼ˆç†è«–çš„ã«ã¯ä¸è¦ã ãŒå®‰å…¨ï¼‰
      if (!latlng) {
        console.warn(
          `Skipping marker operation: latlng is null or undefined for vehicle ${vehicle.id}`
        );
        return;
      }

      const offsetLatLng = L.latLng(latlng.lat, latlng.lng + offset);
      let currentMarkerData;

      if (index === 1) {
        // ä¸­å¤®ï¼ˆã‚ªãƒªã‚¸ãƒŠãƒ«ï¼‰
        currentMarkerData = markerData.original;
      } else {
        // å·¦å³ã®ã‚³ãƒ”ãƒ¼ï¼ˆåœ°çƒã‚’ç¹‹ã’ã‚‹ç”¨ï¼‰
        const copyIndex = index === 0 ? 0 : 1;
        currentMarkerData = markerData.copies[copyIndex];
      }

      if (!currentMarkerData) {
        // ãƒãƒ¼ã‚«ãƒ¼ãŒå­˜åœ¨ã—ãªã‘ã‚Œã°æ–°è¦è¿½åŠ 
        const marker = L.marker(offsetLatLng, { icon: markerIcon }).addTo(map);
        marker.bindPopup(popupContent);

        if (index === 1) {
          markerData.original = marker;
        } else {
          const copyIndex = index === 0 ? 0 : 1;
          markerData.copies[copyIndex] = marker;
        }
      } else {
        // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
        currentMarkerData.setLatLng(offsetLatLng);
        currentMarkerData.setPopupContent(popupContent);

        const rotationStyle = `transform: translate(-50%, -50%)${
          vehicle.rotation ? ` rotate(${vehicle.rotation}deg)` : ""
        };`;

        const newIcon = L.divIcon({
          className: iconClass,
          style: `background-color: ${vehicle.color}; border-color: ${
            vehicle.owner === Game.userId ? "yellow" : "white"
          }; ${rotationStyle}`,
        });
        currentMarkerData.setIcon(newIcon);
      }
    });
  });

  // å­˜åœ¨ã—ãªããªã£ãŸè»Šä¸¡ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
  existingVehicleIds.forEach((vehicleId) => {
    const markerData = Game.allVehicleMarkers[vehicleId];
    if (markerData.original) map.removeLayer(markerData.original);
    markerData.copies.forEach((copy) => {
      if (copy) map.removeLayer(copy);
    });
    delete Game.allVehicleMarkers[vehicleId];
  });
}


      function updateRankingUI(ranking) {
        const list = document.getElementById("ranking-list");
        list.innerHTML = "";
        ranking.forEach((item, index) => {
          const li = document.createElement("li");
          li.innerHTML = `${index + 1}. <b>${item.userId}</b>: Â¥${Math.round(
            item.score
          ).toLocaleString()}`;
          if (item.userId === Game.userId) {
            li.style.fontWeight = "bold";
            li.style.color = "#0044BB";
          }
          list.appendChild(li);
        });
      }

      // =========================================================
      // D. å»ºè¨­ãƒ»è§£ä½“ãƒ­ã‚¸ãƒƒã‚¯ (ã‚µãƒ¼ãƒãƒ¼ã«ã‚³ãƒãƒ³ãƒ‰é€ä¿¡)
      // =========================================================

       function handleStationCreation(e) {
        if (Game.mode !== "station" || !socket) return;
        socket.emit("buildStation", { latlng: [e.latlng.lat, e.latlng.lng] });
      }
      
      function handleAirportCreation(e) {
        if (Game.mode !== "airport" || !socket) return;
        socket.emit("buildAirport", { latlng: [e.latlng.lat, e.latlng.lng] });
      }

      function handleTerminalDismantle(terminal) {
        if (Game.mode !== "dismantle-station" || !socket) return;

        if (terminal.ownerId !== Game.userId) {
          alert("è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã—ã‹è§£ä½“ã§ãã¾ã›ã‚“ã€‚");
          return;
        }
        
        const cost = terminal.isAirport ? AIRPORT_COST : STATION_COST;
        const dismantleCost = Math.round(cost * 0.1);
        
        const type = terminal.isAirport ? 'ç©ºæ¸¯' : 'é§…';

        if (
          confirm(
            `${type} ${terminal.name} (ID: ${terminal.id}) ã‚’è§£ä½“ã—ã¾ã™ã‹ï¼Ÿ (è²»ç”¨: Â¥${dismantleCost.toLocaleString()})`
          )
        ) {
          socket.emit("dismantleTerminal", { terminalId: terminal.id, isAirport: terminal.isAirport });
        }
      }
      
      window.renameTerminalClient = (terminalId, isAirport) => {
        if (!socket) return alert("ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        
        const input = document.getElementById(`rename-input-${terminalId}`);
        const newName = input ? input.value.trim() : null;
        
        if (!newName || newName.length < 2 || newName.length > 20) {
            return alert("åç§°ã¯2æ–‡å­—ä»¥ä¸Š20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        }

        socket.emit("renameTerminal", { terminalId: terminalId, newName: newName, isAirport: isAirport });
      };
      function handleTerminalClick(terminal) {
        if (Game.mode === "track") {
            if (terminal.isAirport) {
                alert("é‰„é“è·¯ç·šã¯ç©ºæ¸¯ã‚’ãƒãƒ¼ãƒ‰ã«ã§ãã¾ã›ã‚“ã€‚");
                return;
            }
            handleTrackNodeClick(terminal);
        } else if (Game.mode === "air-route") {
            handleAirRouteNodeClick(terminal);
        } else if (Game.mode === "dismantle-station") {
            handleTerminalDismantle(terminal);
        } else if (Game.mode === "extend-line" && Game.extendLine.lineId) {
            handleExtendNodeClick(terminal);
        }
      }
            window.upgradeStation = (stationId, newType) => {
        if (!socket) return alert("ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        
        const station = Game.stations.find(s => s.id === stationId);
        if (!station) return;

        let cost = 0;
        const currentType = station.type;

        if (newType === 'Medium' && currentType === 'Small') {
            cost = 50000000; 
        } else if (newType === 'Large' && currentType === 'Small') {
            cost = 150000000; 
        } else if (newType === 'Large' && currentType === 'Medium') {
            cost = 100000000; 
        } else {
            return; 
        }

        if (confirm(`${station.name} ã‚’ ${newType} é§…ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ (è²»ç”¨: Â¥${cost.toLocaleString()})`)) {
            socket.emit("upgradeStation", { stationId: stationId, newType: newType, cost: cost });
        }
      };
      
      function handleTrackNodeClick(station) {
        if (station.ownerId !== "ADMIN_SHARED"){
          if (station.ownerId !== Game.userId) {
            alert("ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é§…ã¯è·¯ç·šã®ãƒãƒ¼ãƒ‰ã¨ã—ã¦ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚");
            return;
          }
        }
          if (lineCandidateNodes.includes(station)) return;

          lineCandidateNodes.push(station);
          updateDrawingPolyline(Game.currentTrackType);
      }
      
      function handleAirRouteNodeClick(terminal) {
          if (terminal.ownerId !== Game.userId && terminal.ownerId !== "ADMIN_SHARED") {
            alert("ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ–½è¨­ã¯ãƒãƒ¼ãƒ‰ã¨ã—ã¦ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚");
            return;
          }

          if (lineCandidateNodes.includes(terminal)) return;

          lineCandidateNodes.push(terminal);
          updateDrawingPolyline('air');
      }
      
      function updateConstructionInfo(trackType) {
          const infoDiv = document.getElementById("construction-info");
          
          let coords = [];
          
          if (Game.mode === 'extend-line' && Game.extendLine.lineId) {
              if (Game.extendLine.extensionNodes.length === 0) {
                  infoDiv.style.display = 'none';
                  currentConstructionCost = 0;
                  currentConstructionDistance = 0;
                  return;
              }
              
              // å»¶é•·é–‹å§‹ç‚¹
              let lastCoord = [Game.extendLine.startTerminal.latlng.lat, Game.extendLine.startTerminal.latlng.lng];
              
              // å»¶é•·ãƒãƒ¼ãƒ‰å…¨ä½“
              coords.push(lastCoord);
              Game.extendLine.extensionNodes.forEach(node => {
                  coords.push([node.latlng.lat, node.latlng.lng]);
              });
              
          } else {
              if (lineCandidateNodes.length < 2) {
                  infoDiv.style.display = 'none';
                  currentConstructionCost = 0;
                  currentConstructionDistance = 0;
                  return;
              }
              coords = lineCandidateNodes.map(t => [t.latlng.lat, t.latlng.lng]);
          }
          
          infoDiv.style.display = 'block';
          
          socket.emit('calculateConstructionCost', { coords: coords, trackType: trackType }, (result) => {
              if (result.success) {
                  currentConstructionCost = result.totalCost;
                  currentConstructionDistance = result.totalLengthKm;
                  
                  document.getElementById("construction-distance").textContent = `${currentConstructionDistance.toFixed(2)} km`;
                  document.getElementById("construction-cost").textContent = `Â¥${Math.round(currentConstructionCost).toLocaleString()}`;
                  
                  const terrainPercent = ((result.avgTerrainMultiplier - 1) * 100).toFixed(1);
                  document.getElementById("construction-terrain").textContent = `${terrainPercent}%`;
                  
                  // å»¶é•·ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ã‚³ã‚¹ãƒˆè¨ˆç®—ãŒå®Œäº†ã—ãŸã‚‰ç¢ºå®šãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                  if (Game.mode === 'extend-line' && Game.extendLine.extensionNodes.length > 0) {
                      document.getElementById('btn-extend-line-confirm').disabled = false;
                  }
              }
          });
      }
      
      function updateDrawingPolyline(trackType) {
          const currentCoords = lineCandidateNodes.map((t) => [
            t.latlng.lat,
            t.latlng.lng,
          ]);

          if (currentCoords.length >= 2) {
            let weight = 7;
            let dashArray = "10, 10";
            let color = "#C0C0C0";
            
            if (trackType === "double") weight = 12;
            else if (trackType === "linear") weight = 15;
            else if (trackType === "tram") weight = 6;
            else if (trackType === "air") {
                weight = 2;
                color = "#007bff";
                dashArray = "5, 10";
            }

            if (drawingPolyline) {
              drawingPolyline
                .setLatLngs(currentCoords)
                .setStyle({ color: color, weight: weight, dashArray: dashArray });
            } else {
              drawingPolyline = L.polyline(currentCoords, {
                color: color,
                weight: weight,
                opacity: 0.8,
                dashArray: dashArray,
              }).addTo(map);
            }
          }
          
          updateConstructionInfo(trackType);
      }

      function finalizeLine() {
        if (lineCandidateNodes.length < 2 || !socket) {
          alert("è·¯ç·šã«ã¯2ã¤ä»¥ä¸Šã®é§…ãŒå¿…è¦ã§ã™ã€‚");
          return;
        }
        
        if (lineCandidateNodes.some(t => t.isAirport)) {
            alert("é‰„é“è·¯ç·šã«ã¯ç©ºæ¸¯ã‚’å«ã‚ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚èˆªç©ºè·¯ç·šç¢ºå®šãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        const stationCoords = lineCandidateNodes.map((s) => [
          s.latlng.lat,
          s.latlng.lng,
        ]);

        socket.emit("buildLine", {
          terminalCoords: stationCoords,
          trackType: Game.currentTrackType,
        });

        resetLineDrawing();
        toggleConstructionMode("idle");
      }
      
      function finalizeAirRoute() {
        if (lineCandidateNodes.length < 2 || !socket) {
          alert("èˆªç©ºè·¯ç·šã«ã¯2ã¤ä»¥ä¸Šã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãŒå¿…è¦ã§ã™ã€‚");
          return;
        }
        
        const terminalCoords = lineCandidateNodes.map((t) => [
          t.latlng.lat,
          t.latlng.lng,
        ]);

        socket.emit("buildLine", {
          terminalCoords: terminalCoords,
          trackType: 'air',
        });

        resetLineDrawing();
        toggleConstructionMode("idle");
      }
      
      function resetLineDrawing() {
        if (drawingPolyline) map.removeLayer(drawingPolyline);
        lineCandidateNodes = [];
        drawingPolyline = null;
        document.getElementById("construction-info").style.display = 'none';
        currentConstructionCost = 0;
        currentConstructionDistance = 0;
      }
      
      // --- è·¯ç·šå»¶é•·æ©Ÿèƒ½é–¢é€£ã®ãƒ­ã‚¸ãƒƒã‚¯ ---

      function handleLineSelectionForExtension(lineData, e) {
          if (Game.mode !== 'extend-line') return;
          
          // è‡ªåˆ†ã®è·¯ç·šã§ãªã‘ã‚Œã°é¸æŠä¸å¯
          if (lineData.ownerId !== Game.userId) {
              socket.emit('error', 'è‡ªåˆ†ã®è·¯ç·šã®ã¿å»¶é•·å¯èƒ½ã§ã™ã€‚');
              return;
          }
          
          // æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤ã—ã€çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
          resetExtendLineState();
          
          Game.extendLine.lineId = lineData.id;
          Game.extendLine.lineData = lineData;
          
          // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸä½ç½®ãŒå§‹ç‚¹ã«è¿‘ã„ã‹çµ‚ç‚¹ã«è¿‘ã„ã‹ã‚’åˆ¤å®š
          const coords = lineData.coords;
          const startCoord = L.latLng(coords[0][0], coords[0][1]);
          const endCoord = L.latLng(coords[coords.length - 1][0], coords[coords.length - 1][1]);
          
          const distToStart = e.latlng.distanceTo(startCoord);
          const distToEnd = e.latlng.distanceTo(endCoord);
          
          const isExtendStart = distToStart < distToEnd;
          Game.extendLine.isExtendStart = isExtendStart;
          
          // å»¶é•·é–‹å§‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’ç‰¹å®š
          const terminalList = Game.stations.concat(Game.airports);
          const startTerminalCoord = isExtendStart ? coords[0] : coords[coords.length - 1];
          
          const startTerminal = terminalList.find(t => 
              t.latlng.lat === startTerminalCoord[0] && t.latlng.lng === startTerminalCoord[1]
          );
          
          if (!startTerminal) {
              socket.emit('error', 'è·¯ç·šã®ç«¯ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
              cancelLineExtension();
              return;
          }
          
          Game.extendLine.startTerminal = startTerminal;
          
          document.getElementById('extend-line-hint').textContent = 
              `è·¯ç·š L${lineData.id} (${lineData.trackType}) ã‚’${isExtendStart ? 'å§‹ç‚¹' : 'çµ‚ç‚¹'}ã‹ã‚‰å»¶é•·ã—ã¾ã™ã€‚æ¬¡ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`;
          
          document.getElementById('btn-extend-line-select').classList.add('active');
          document.getElementById('btn-extend-line-cancel').disabled = false;
          
          // æ—¢å­˜ã®è·¯ç·šãƒãƒªãƒ©ã‚¤ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          if (Game.allLines[lineData.id]) {
              Game.allLines[lineData.id].forEach(p => p.setStyle({ weight: 12, opacity: 1, dashArray: '5, 5' }));
          }
      }

      function handleExtendNodeClick(terminal) {
          if (Game.mode !== 'extend-line' || !Game.extendLine.lineId) {
              socket.emit('error', 'å…ˆã«å»¶é•·å¯¾è±¡ã®è·¯ç·šã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
              return;
          }
          
          // å»¶é•·é–‹å§‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã¨åŒã˜å ´æ‰€ã¯é¸æŠä¸å¯
          if (terminal.id === Game.extendLine.startTerminal.id) {
              socket.emit('error', 'å»¶é•·é–‹å§‹ç‚¹ã¨åŒã˜ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã¯é¸æŠã§ãã¾ã›ã‚“ã€‚');
              return;
          }
          
          // æ—¢ã«é¸æŠã•ã‚ŒãŸãƒãƒ¼ãƒ‰ã¯é¸æŠä¸å¯
          if (Game.extendLine.extensionNodes.some(node => node.id === terminal.id)) {
              socket.emit('error', 'ã“ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã¯æ—¢ã«å»¶é•·ãƒãƒ¼ãƒ‰ã¨ã—ã¦é¸æŠã•ã‚Œã¦ã„ã¾ã™ã€‚');
              return;
          }
          
          // è·¯ç·šã‚¿ã‚¤ãƒ—é©åˆæ€§ãƒã‚§ãƒƒã‚¯
          const isAirRoute = Game.extendLine.lineData.trackType === 'air';
          if (isAirRoute && !terminal.isAirport) {
              socket.emit('error', 'èˆªç©ºè·¯ç·šã¯ç©ºæ¸¯ã«ã®ã¿å»¶é•·ã§ãã¾ã™ã€‚');
              return;
          }
          if (!isAirRoute && terminal.isAirport) {
              socket.emit('error', 'é‰„é“è·¯ç·šã¯é‰„é“é§…ã«ã®ã¿å»¶é•·ã§ãã¾ã™ã€‚');
              return;
          }
          
          // æ¨©é™ãƒã‚§ãƒƒã‚¯
          if (terminal.ownerId !== Game.userId && terminal.ownerId !== 'ADMIN_SHARED') {
              socket.emit('error', 'ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ–½è¨­ã¯å»¶é•·ãƒãƒ¼ãƒ‰ã¨ã—ã¦ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚');
              return;
          }

          Game.extendLine.extensionNodes.push(terminal);
          
          // ä»®ãƒãƒªãƒ©ã‚¤ãƒ³ã®æç”»
          drawTransientExtension();
          
          document.getElementById('extend-line-hint').textContent = 
              `ãƒãƒ¼ãƒ‰æ•°: ${Game.extendLine.extensionNodes.length}ã€‚æ¬¡ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ã€ç¢ºå®šã—ã¦ãã ã•ã„ã€‚`;
          
          document.getElementById('btn-extend-line-confirm').disabled = false;
          document.getElementById('btn-extend-line-delete').disabled = false;
      }
            
      window.requestLoan = () => {
          if (!socket) return alert("ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          
          const amountM = parseFloat(document.getElementById('loan-amount-input').value);
          const termMonths = parseInt(document.getElementById('loan-term-input').value);
          
          if (isNaN(amountM) || amountM <= 0 || isNaN(termMonths) || termMonths < 6) {
              return alert("å€Ÿå…¥é¡ã¯æ­£ã®å€¤ã§ã€æœŸé–“ã¯6ãƒ¶æœˆä»¥ä¸Šã«è¨­å®šã—ã¦ãã ã•ã„ã€‚");
          }
          
          const amount = Math.round(amountM * 1000000);
          
          if (amount > Game.money * 10) { 
              if (!confirm(`å€Ÿå…¥é¡ Â¥${amount.toLocaleString()} ã¯ç¾åœ¨ã®è³‡é‡‘ã®10å€ä»¥ä¸Šã§ã™ã€‚æœ¬å½“ã«å€Ÿã‚Šã¾ã™ã‹ï¼Ÿ`)) {
                  return;
              }
          }
          
          socket.emit('requestLoan', { amount: amount, termMonths: termMonths });
      };
      function drawTransientExtension() {
          const lineData = Game.extendLine.lineData;
          const isAirRoute = lineData.trackType === 'air';
          
          // æ—¢å­˜è·¯ç·šã®ç«¯ç‚¹
          const startCoord = [Game.extendLine.startTerminal.latlng.lat, Game.extendLine.startTerminal.latlng.lng];
          
          // å»¶é•·ãƒãƒ¼ãƒ‰ã®åº§æ¨™ãƒªã‚¹ãƒˆ
          const extensionCoords = Game.extendLine.extensionNodes.map(node => [node.latlng.lat, node.latlng.lng]);
          
          const fullCoords = [startCoord, ...extensionCoords];
          
          const color = isAirRoute ? '#007bff' : '#FF0000';
          const weight = isAirRoute ? 3 : 10;
          
          if (Game.extendLine.transientPolyline) {
              map.removeLayer(Game.extendLine.transientPolyline);
          }
          
          Game.extendLine.transientPolyline = L.polyline(fullCoords, {
              color: color,
              weight: weight,
              opacity: 0.7,
              dashArray: '1, 5',
          }).addTo(map);
          
          updateConstructionInfo(lineData.trackType);
      }
      
      window.confirmLineExtension = () => {
          if (!Game.extendLine.lineId || Game.extendLine.extensionNodes.length === 0 || currentConstructionCost === 0) {
              socket.emit('error', 'å»¶é•·ã™ã‚‹åŒºé–“ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
              return;
          }
          
          const lineId = Game.extendLine.lineId;
          const newTerminalCoords = Game.extendLine.extensionNodes.map(node => [node.latlng.lat, node.latlng.lng]);
          const isExtendStart = Game.extendLine.isExtendStart;
          
          if (confirm(`è·¯ç·š L${lineId} ã‚’å»¶é•·ã—ã¾ã™ã‹ï¼Ÿ è²»ç”¨: Â¥${currentConstructionCost.toLocaleString()}`)) {
              socket.emit('extendLine', {
                  lineId: lineId,
                  newTerminalCoords: newTerminalCoords,
                  isExtendStart: isExtendStart
              });
              cancelLineExtension();
          }
      }
      
      window.cancelLineExtension = () => {
          if (!Game.extendLine.lineData) {
              // è·¯ç·šãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯UIã ã‘ãƒªã‚»ãƒƒãƒˆ
              resetExtendLineState();
              return;
          }
          
          // ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤
          if (Game.extendLine.lineId && Game.allLines[Game.extendLine.lineId]) {
              const lineData = Game.extendLine.lineData;
              let weight = 8;
              let dashArray = null;
              if (lineData.trackType === "double") weight = 12;
              else if (lineData.trackType === "linear") weight = 15;
              else if (lineData.trackType === "tram") weight = 6;
              else if (lineData.trackType === "air") { weight = 2; dashArray = '5, 10'; }
              
              Game.allLines[Game.extendLine.lineId].forEach(p => p.setStyle({ 
                  weight: weight, 
                  opacity: lineData.ownerId === Game.userId ? 1 : 0.7, 
                  dashArray: dashArray 
              }));
          }
          
          resetExtendLineState();
          toggleConstructionMode('idle');
      }
      
      function resetExtendLineState() {
          if (Game.extendLine.transientPolyline) {
              map.removeLayer(Game.extendLine.transientPolyline);
          }
          
          Game.extendLine = {
              active: false,
              lineId: null,
              lineData: null,
              isExtendStart: null,
              startTerminal: null,
              extensionNodes: [],
              transientPolyline: null,
          };
          
          // UIã‚’ãƒªã‚»ãƒƒãƒˆ
          document.getElementById('extend-line-hint').textContent = 'å»¶é•·ã—ãŸã„è·¯ç·šã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚';
          document.getElementById('btn-extend-line-select').classList.remove('active');
          document.getElementById('btn-extend-line-confirm').disabled = true;
          document.getElementById('btn-extend-line-cancel').disabled = true;
          document.getElementById('btn-extend-line-delete').disabled = true;
          document.getElementById("construction-info").style.display = 'none';
      }
      
      window.deleteTransientExtension = () => {
          if (Game.extendLine.transientPolyline) {
              map.removeLayer(Game.extendLine.transientPolyline);
              Game.extendLine.transientPolyline = null;
          }
          Game.extendLine.extensionNodes = [];
          
          document.getElementById('btn-extend-line-confirm').disabled = true;
          document.getElementById('btn-extend-line-delete').disabled = true;
          
          const lineData = Game.extendLine.lineData;
          if (lineData) {
              const direction = Game.extendLine.isExtendStart ? 'å§‹ç‚¹' : 'çµ‚ç‚¹';
              document.getElementById('extend-line-hint').textContent = 
                  `è·¯ç·š L${lineData.id} ã‚’${direction}ã‹ã‚‰å»¶é•·ã—ã¾ã™ã€‚æ¬¡ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`;
          }
          updateConstructionInfo(Game.extendLine.lineData ? Game.extendLine.lineData.trackType : 'single');
      }

      function handleLineDismantle(e) {
        if (Game.mode !== "dismantle-line" || !socket) return;

        let closestLineId = null;
        let minDistance = Infinity;
        const lineSearchRadiusKm = 0.05; 

        const clickPoint = turf.point([e.latlng.lng, e.latlng.lat]);

        Object.entries(Game.allLines).forEach(([lineId, polylines]) => {
          polylines.forEach(polyline => {
              if (!polyline) return;

              const latlngs = polyline.getLatLngs();
              const coords = latlngs.map(ll => [ll.lng, ll.lat]);
              
              if (coords.length < 2) return;

              const line = turf.lineString(coords);
              
              const distanceKm = turf.pointToLineDistance(clickPoint, line, { units: 'kilometers' });
              
              if (distanceKm < minDistance && distanceKm < lineSearchRadiusKm) {
                  minDistance = distanceKm;
                  closestLineId = lineId;
              }
          });
        });


        if (!closestLineId) {
          alert("ã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã®è¿‘ãã«è§£ä½“ã§ãã‚‹è·¯ç·šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        const lineData = Game.establishedLines.find((l) => l.id == closestLineId);

        if (!lineData || lineData.ownerId !== Game.userId) {
          alert("è‡ªåˆ†ã®è·¯ç·š/èˆªç©ºè·¯ç·šã®ã¿è§£ä½“å¯èƒ½ã§ã™ã€‚");
          return;
        }

        const dismantleCost = Math.round(lineData.cost * 0.1);
        if (
          confirm(
            `è·¯ç·š ${closestLineId} ã‚’è§£ä½“ã—ã¾ã™ã‹ï¼Ÿ (è²»ç”¨: Â¥${dismantleCost.toLocaleString()}ã€è»Šä¸¡ã¯è³¼å…¥ä¾¡æ ¼ã®1/3ã§è‡ªå‹•å£²å´ã•ã‚Œã¾ã™)`
          )
        ) {
          socket.emit("dismantleLine", { lineId: parseInt(closestLineId) });
        }
      }


      // =========================================================
      // E. UIã¨ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
      // =========================================================

      function toggleConstructionMode(newMode) {
        if (Game.mode === newMode) {
            newMode = 'idle'; // Toggle off if already active
        }
        const mapContainer = map.getContainer();

        const isLineMode = newMode === "track" || newMode === "air-route";
        const isExtendSelectMode = newMode === "extend-line";
        
        // è·¯ç·šãƒ¢ãƒ¼ãƒ‰ã€èˆªç©ºè·¯ç·šãƒ¢ãƒ¼ãƒ‰ã€ã¾ãŸã¯å»¶é•·ãƒ¢ãƒ¼ãƒ‰ã®ã„ãšã‚Œã‹ã§ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
        document.getElementById("extend-line-panel").style.display = isLineMode || isExtendSelectMode ? 'block' : 'none';
        
        // å»¶é•·ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ« (å»¶é•·é¸æŠãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ä»–ã®ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆãŸå ´åˆ)
        if (!isExtendSelectMode && Game.extendLine.lineId) {
            cancelLineExtension();
        }

        // Remove all mode classes
        L.DomUtil.removeClass(mapContainer, "station-mode");
        L.DomUtil.removeClass(mapContainer, "airport-mode");
        L.DomUtil.removeClass(mapContainer, "dismantle-station-mode");
        L.DomUtil.removeClass(mapContainer, "dismantle-line-mode");
        
        // Reset line drawing if switching modes
        if (newMode !== "track" && newMode !== "air-route") {
            resetLineDrawing();
        }

        // Reset all buttons
        document.querySelectorAll('.rail-ui-control button').forEach(btn => {
            if (btn.id && btn.id.startsWith('btn-')) {
                 btn.classList.remove('active');
            }
        });

        Game.mode = newMode;
        
        switch (newMode) {
            case "station":
                L.DomUtil.addClass(mapContainer, "station-mode");
                document.getElementById("btn-station-mode").classList.add('active');
                break;
            case "airport":
                L.DomUtil.addClass(mapContainer, "airport-mode");
                document.getElementById("btn-airport-mode").classList.add('active');
                break;
            case "track":
                L.DomUtil.addClass(mapContainer, "track-mode");
                document.getElementById("btn-track-mode").classList.add('active');
                // Ensure track type is rail compatible
                if (Game.currentTrackType === 'air') Game.currentTrackType = 'single';
                document.getElementById('track-type').value = Game.currentTrackType;
                break;
            case "air-route":
                L.DomUtil.addClass(mapContainer, "air-route-mode");
                document.getElementById("btn-air-route-mode").classList.add('active');
                // Ensure track type is air
                Game.currentTrackType = 'air';
                document.getElementById('track-type').value = 'air';
                break;
            case "dismantle-station":
                L.DomUtil.addClass(mapContainer, "dismantle-station-mode");
                document.getElementById("btn-dismantle-station-mode").classList.add('active');
                break;
            case "dismantle-line":
                L.DomUtil.addClass(mapContainer, "dismantle-line-mode");
                document.getElementById("btn-dismantle-line-mode").classList.add('active');
                break;
            case "extend-line":
                L.DomUtil.addClass(mapContainer, "track-mode"); // Use track mode cursor for selection
                document.getElementById("btn-extend-line-select").classList.add('active');
                break;
            case "idle":
            default:
                // No specific class needed
                break;
        }
      }
      
      function handleMapClick(e) {
        if (Game.mode === "station") {
          handleStationCreation(e);
        } else if (Game.mode === "airport") {
          handleAirportCreation(e);
        } else if (Game.mode === "dismantle-line") {
          handleLineDismantle(e);
        } else if (Game.mode === "track" || Game.mode === "air-route") {
          // è·¯ç·šãƒ¢ãƒ¼ãƒ‰ã§ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã€æœ€å¾Œã®ãƒãƒ¼ãƒ‰ã‚’å‰Šé™¤
          if (lineCandidateNodes.length > 0) {
            lineCandidateNodes.pop();
            updateDrawingPolyline(Game.currentTrackType);
          }
        }
      }

      function updateVehicleBuyUI() {
        const container = document.getElementById("vehicle-buy-container");
        container.innerHTML = "<h3>ğŸš‚ è»Šä¸¡è³¼å…¥</h3>";

        if (Game.establishedLines.length === 0) {
          container.innerHTML += "<p>è»Šä¸¡ã‚’è³¼å…¥ã™ã‚‹ã«ã¯ã€ã¾ãšè·¯ç·šã‚’å»ºè¨­ã—ã¦ãã ã•ã„ã€‚</p>";
          return;
        }

        Game.establishedLines.forEach((line) => {
          console.log("Line data:", line);

          const lineDiv = document.createElement("div");
          lineDiv.style.border = `1px solid ${line.color}`;
          lineDiv.style.padding = "5px";
          lineDiv.style.margin = "5px 0";
          lineDiv.innerHTML = `<h4>L${line.id} (${line.trackType}) - ${line.coords.length}ãƒãƒ¼ãƒ‰</h4>`;

          const vehicleList = document.createElement("select");
          vehicleList.id = `vehicle-select-${line.id}`;
          vehicleList.style.marginBottom = "5px";

          const isAirRoute = line.trackType === 'air';
          const isLinearRoute = line.trackType === 'linear';

          Object.entries(VehicleData).forEach(([key, data]) => {
            // è·¯ç·šã‚¿ã‚¤ãƒ—ã¨è»Šä¸¡ã‚«ãƒ†ã‚´ãƒªã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
            if (isAirRoute && data.category !== 'air') return;
            if (!isAirRoute && data.category === 'air') return;
            if (isLinearRoute && key !== 'LINEAR') return;
            if (!isLinearRoute && key === 'LINEAR') return;

            const baseCost = data.category === 'air' ? AIRPLANE_BASE_COST : VEHICLE_BASE_COST;
            const cost = baseCost * data.purchaseMultiplier;
            const option = document.createElement("option");
            option.value = key;
            option.textContent = `${data.name} (${key}) - Â¥${cost.toLocaleString()}`;
            vehicleList.appendChild(option);
          });

          if (vehicleList.options.length === 0) {
              lineDiv.innerHTML += `<p>ã“ã®è·¯ç·šã‚¿ã‚¤ãƒ—ã®è»Šä¸¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
              container.appendChild(lineDiv);
              return;
          }

          lineDiv.appendChild(vehicleList);
          
          // ç·¨æˆæ•°å…¥åŠ› (èˆªç©ºæ©Ÿã¯1å›ºå®š)
          const maxFormation = VehicleData[vehicleList.value]?.maxFormation || 1;
          const formationInput = document.createElement("input");
          formationInput.type = "number";
          formationInput.id = `formation-input-${line.id}`;
          formationInput.min = 1;
          formationInput.max = maxFormation;
          formationInput.value = 1;
          formationInput.placeholder = "ç·¨æˆæ•°";
          formationInput.style.width = "50%";
          formationInput.style.marginRight = "5px";

          // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã—ã¦ã€é¸æŠãŒå¤‰ã‚ã£ãŸã‚‰æœ€å¤§ç·¨æˆæ•°ã‚’æ›´æ–°
          vehicleList.addEventListener('change', (e) => {
              const selectedKey = e.target.value;
              const newMax = VehicleData[selectedKey]?.maxFormation || 1;
              formationInput.max = newMax;
              formationInput.value = Math.min(parseInt(formationInput.value), newMax);
              formationInput.disabled = newMax === 1;
          });
          
          if (maxFormation > 1) {
              lineDiv.appendChild(formationInput);
          } else {
              formationInput.disabled = true;
          }
          
          const buyButton = document.createElement("button");
          buyButton.textContent = "è³¼å…¥";
          buyButton.style.width = maxFormation > 1 ? "45%" : "100%";
          buyButton.onclick = () => {
            const vehicleKey = document.getElementById(`vehicle-select-${line.id}`).value;
            const formationSize = maxFormation > 1 ? parseInt(document.getElementById(`formation-input-${line.id}`).value) : 1;
            
            if (formationSize < 1 || formationSize > maxFormation || isNaN(formationSize)) {
                alert(`ç·¨æˆæ•°ã¯1ã‹ã‚‰${maxFormation}ã®é–“ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚`);
                return;
            }
            
            socket.emit("buyVehicle", { lineId: line.id, vehicleKey: vehicleKey, formationSize: formationSize });
          };
          lineDiv.appendChild(buyButton);
          
          container.appendChild(lineDiv);
        });
      }

      function updateLineManagementUI() {
        const container = document.getElementById("line-management-container");
        container.innerHTML = "";

        if (Game.establishedLines.length === 0) {
          container.innerHTML = "<p>è·¯ç·šãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
          document.getElementById("line-config-panel").style.display = 'none';
          return;
        }
        
        Game.establishedLines.forEach((line) => {
            const lineDiv = document.createElement("div");
            lineDiv.style.padding = "5px";
            lineDiv.style.margin = "3px 0";
            lineDiv.style.borderLeft = `5px solid ${line.color}`;
            lineDiv.style.backgroundColor = '#f9f9f9';
            lineDiv.style.cursor = 'pointer';
            lineDiv.title = `L${line.id} (${line.trackType}) - ${line.lengthKm.toFixed(1)} km`;
            
            lineDiv.innerHTML = `L${line.id} (${line.trackType}) - Â¥${(line.cost / 1000000).toFixed(1)}M`;
            
            lineDiv.onclick = () => showLineConfigPanel(line.id);
            
            container.appendChild(lineDiv);
        });
        
        // è·¯ç·šãƒªã‚¹ãƒˆæ›´æ–°å¾Œã€ã‚‚ã—è¨­å®šãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ãŸã‚‰å†è¡¨ç¤º
        if (currentConfigLineId) {
            showLineConfigPanel(currentConfigLineId);
        }
      }
      
      function showLineConfigPanel(lineId) {
          const panel = document.getElementById("line-config-panel");
          const line = Game.establishedLines.find(l => l.id === lineId);
          
          if (!line) {
              panel.style.display = 'none';
              currentConfigLineId = null;
              return;
          }
          
          currentConfigLineId = lineId;
          document.getElementById("config-line-id").textContent = lineId;
          
          // é‹è³ƒè¨­å®š
          const fareInput = document.getElementById("fare-multiplier-input");
          fareInput.value = line.fareMultiplier || 1.0;
          updateFareDisplay(fareInput.value);
          
          // ã‚µãƒ¼ãƒ“ã‚¹è¨­å®š
          const serviceOptionsContainer = document.getElementById("service-options-container");
          serviceOptionsContainer.innerHTML = '';
          
          Object.entries(SERVICE_SETTINGS).forEach(([key, settings]) => {
              const serviceDiv = document.createElement('div');
              serviceDiv.style.marginBottom = '5px';
              
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.id = `service-check-${lineId}-${key}`;
              // servicesã¯Objectã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹ã®ã§ã€ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹
              checkbox.checked = line.services[key] || false; 
              checkbox.onchange = (e) => {
                  socket.emit('setLineService', { lineId: lineId, serviceKey: key, enabled: e.target.checked });
              };
              
              const label = document.createElement('label');
              label.htmlFor = checkbox.id;
              label.textContent = `${settings.name} (+${(settings.popularityBonus * 100).toFixed(0)}%äººæ°—åº¦, ç¶­æŒè²»: ${(settings.monthlyCostFactor * 100).toFixed(3)}%)`;
              
              serviceDiv.appendChild(checkbox);
              serviceDiv.appendChild(label);
              serviceOptionsContainer.appendChild(serviceDiv);
          });

          panel.style.display = 'block';
      }
      
      function updateFareDisplay(value) {
          document.getElementById("current-fare-multiplier").textContent = parseFloat(value).toFixed(2);
      }

      function setLineFare() {
          if (!currentConfigLineId) return;
          const fareInput = document.getElementById("fare-multiplier-input");
          const fareMultiplier = parseFloat(fareInput.value);
          socket.emit('setLineFare', { lineId: currentConfigLineId, fareMultiplier: fareMultiplier });
      }
      
      function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (message) {
            socket.emit('sendMessage', { message: message });
            input.value = '';
        }
      }
      
      function appendChatMessage(userId, message, timestamp) {
        const chatMessages = document.getElementById('chat-messages');
        const msgDiv = document.createElement('div');
        const date = new Date(timestamp);
        const timeString = Number.isNaN(date.getTime())
          ? ''
          : ` <span class="chat-timestamp">${date.toLocaleTimeString('ja-JP', {
              hour: '2-digit',
              minute: '2-digit',
            })}</span>`;

        msgDiv.innerHTML = `<strong>${userId}</strong>: ${message}${timeString}`;
        msgDiv.classList.add('chat-message-row');
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function toggleAccordion(contentId) {
        const content = document.getElementById(contentId);
        if (!content) return;

        const toggleIconIdMap = {
          'stats-content': 'stats-toggle-icon',
          'news-content': 'news-toggle-icon',
          'control-content': 'control-toggle-icon',
          'chat-content': 'chat-toggle-icon',
          'ranking-content': 'ranking-toggle-icon',
        };

        const isOpening = !content.classList.contains('open');
        content.classList.toggle('open');

        const iconId = toggleIconIdMap[contentId];
        if (iconId) {
          const icon = document.getElementById(iconId);
          if (icon) icon.textContent = isOpening ? 'â–¼' : 'â–²';
        }

        if (isOpening) {
          content.style.maxHeight = '';
        } else {
          content.style.maxHeight = '0';
        }
      }

      function initializeMap() {
        const mapInstance = L.map('map', {
          worldCopyJump: true,
        }).setView([INITIAL_LAT, INITIAL_LNG], 7);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(mapInstance);

        mapInstance.on('click', handleMapClick);
        return mapInstance;
      }

      function bindUiEvents() {
        const trackTypeSelect = document.getElementById('track-type');
        if (trackTypeSelect) {
          trackTypeSelect.addEventListener('change', (event) => {
            const value = event.target.value;
            Game.currentTrackType = value === 'air' ? 'air' : value;
            if (Game.mode === 'air-route' && value !== 'air') {
              toggleConstructionMode('air-route');
            }
            if (Game.mode === 'track' && value === 'air') {
              toggleConstructionMode('track');
            }
          });
        }

        const chatInput = document.getElementById('chat-input');
        if (chatInput) {
          chatInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
              event.preventDefault();
              sendMessage();
            }
          });
        }
      }

      function restoreSessionIfAvailable() {
        const existingUser = getCookie('userId');
        if (!existingUser) return;

        Game.userId = existingUser;
        const overlay = document.getElementById('login-overlay');
        if (overlay) overlay.style.display = 'none';
        connectSocket(existingUser);
      }

      document.addEventListener('DOMContentLoaded', () => {
        map = initializeMap();
        bindUiEvents();
        restoreSessionIfAvailable();
      });
    </script>
  </body>
</html>
</html>
